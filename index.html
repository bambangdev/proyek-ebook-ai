<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pembuat Ebook AI</title>
    <!-- Google Fonts & Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5; --primary-hover: #4338ca; --green-color: #16a34a;
            --red-color: #ef4444; --orange-color: #f97316; --blue-color: #3b82f6;
            --background-color: #f1f5f9; --text-color: #334155; --subtle-text: #64748b;
            --border-color: #e5e7eb; --card-bg: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 1rem; box-sizing: border-box; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .app-container, .auth-container, .admin-container { background-color: var(--card-bg); width: 100%; max-width: 64rem; margin-left: auto; margin-right: auto; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .auth-container { max-width: 28rem; }
        .auth-form { display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        .app-header { text-align: center; margin-bottom: 1.5rem; }
        .app-header h1 { font-size: 1.875rem; font-weight: 700; }
        .app-header p { color: var(--subtle-text); margin-top: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
        @media (min-width: 1024px) { .form-grid { grid-template-columns: 2fr 1fr 1fr 1fr; } }
        .form-grid input, .form-grid select, .form-grid button { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        .btn { border: none; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); transition: background-color 0.2s; padding: 0.6rem 1rem; height: 42px; text-decoration: none; }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .user-info { font-size: 0.8rem; color: var(--subtle-text); margin-bottom: 1rem; text-align: left; word-break: break-all;}
        .hidden { display: none !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--card-bg); padding: 20px; border-radius: 0.75rem; width: 90%; max-width: 500px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-body { max-height: 70vh; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; margin-top: 1rem; gap: 0.75rem; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .table-container { overflow-x: auto; margin-top: 1rem; max-height: 60vh; }
        table { width: 100%; min-width: 700px; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        thead { background-color: #f9fafb; position: sticky; top: 0; z-index: 10;}
        #toast-notification { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; opacity: 0; transition: visibility 0.5s, opacity 0.5s, bottom 0.5s; }
        #toast-notification.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast-notification.success { background-color: var(--green-color); }
        #toast-notification.error { background-color: var(--red-color); }
    </style>
</head>
<body>

    <div id="app-root">
        <div id="loading-view" class="auth-container fade-in">
            <h2 class="app-header">Memuat Aplikasi...</h2>
            <p id="auth-status" style="text-align: center; color: var(--subtle-text);"></p>
        </div>

        <div id="auth-view" class="hidden">
            <div class="auth-container">
            </div>
        </div>
        
        <div id="claim-license-view" class="hidden">
            <div class="auth-container">
                <h2 class="app-header">Selamat Datang!</h2>
                <p style="text-align: center; color: var(--subtle-text);">Akun Anda belum aktif. Silakan masukkan kunci lisensi yang Anda dapatkan dari admin.</p>
                <form id="claim-license-form" class="auth-form" style="margin-top: 1.5rem;">
                    <input type="text" id="license-key-input" placeholder="Masukkan Kunci Lisensi" required>
                    <button type="submit" class="btn" style="background-color: var(--green-color);">Aktifkan Akun</button>
                </form>
                 <button id="logout-btn-claim" class="btn" style="background-color: var(--red-color); width: 100%; margin-top: 1rem;">Keluar</button>
            </div>
        </div>

        <div id="app-view" class="hidden">
            <div id="main-container" class="app-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap;">
                     <div class="user-info">
                        <p>Email: <strong id="active-user-email"></strong></p>
                        <p>Paket Aktif: <strong id="active-user-tier" style="text-transform: capitalize;"></strong></p>
                        <p>Sisa Kuota Bulan Ini: <strong id="active-user-quota"></strong> ebook</p>
                    </div>
                    <div>
                        <button id="admin-area-btn" class="btn hidden" style="background-color: var(--orange-color); margin-right: 1rem;">Area Admin</button>
                        <button id="logout-btn" class="btn" style="background-color: var(--red-color);">Keluar</button>
                    </div>
                </div>
                <div class="app-header"><h1>Ebook Generator AI</h1></div>
                <div id="generator-ui">
                    <div class="form-grid">
                        <input type="text" id="topic" placeholder="Masukkan topik ebook...">
                        <select id="style"><option value="Santai dan Menarik">Gaya: Santai</option><option value="Formal dan Edukatif">Gaya: Formal</option><option value="Inspiratif dan Motivasi">Gaya: Motivasi</option></select>
                        <select id="persona"><option value="Pakar di Bidangnya">Persona: Pakar</option><option value="Jurnalis Investigatif">Persona: Jurnalis</option><option value="Pencerita yang Handal">Persona: Pencerita</option></select>
                        <button id="add-to-queue-btn" class="btn" style="background-color: var(--blue-color);"><i data-lucide="plus-circle"></i><span>Tambah</span></button>
                    </div>
                    <h2>Antrean Ebook</h2>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Topik</th><th>Gaya</th><th>Persona</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody id="queue-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="quota-limit-view" class="hidden" style="text-align: center; padding: 2rem; border: 2px dashed var(--border-color); border-radius: 0.5rem;">
                    <h2>Kuota Habis</h2>
                    <p>Kuota ebook Anda untuk bulan ini telah habis.</p>
                </div>
                 <div style="margin-top: 2rem;"><button id="process-queue-btn" class="btn" style="background-color: var(--primary-color);" disabled><i data-lucide="play-circle"></i><span>Mulai Proses Antrean</span></button></div>
            </div>

            <div id="admin-view" class="admin-container hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h1 class="app-header" style="margin: 0;">Manajemen Lisensi</h1>
                    <button id="back-to-app-btn" class="btn" style="background-color: var(--blue-color);">Kembali ke Aplikasi</button>
                </div>
                <div class="admin-form" style="margin-bottom: 2rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 0.5rem;">
                    <h3>Buat Lisensi Baru</h3>
                    <form id="create-license-form" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="new-license-key" placeholder="Masukkan Kode Lisensi Baru" required style="flex-grow: 1;">
                        <select id="new-license-tier" style="width: 150px; height: 42px; border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.6rem 0.75rem;"><option value="coba-coba">Coba-coba</option><option value="pemula">Pemula</option><option value="kreator">Kreator</option><option value="tertinggi">Tertinggi</option></select>
                        <button type="submit" class="btn" style="background-color: var(--green-color);">Buat</button>
                    </form>
                </div>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                    <input type="search" id="admin-search-input" placeholder="Cari kode atau email..." style="flex-grow: 1; height: 42px; border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.6rem 0.75rem;">
                    <select id="admin-filter-select" style="height: 42px; border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.6rem 0.75rem;"><option value="all">Semua Lisensi</option><option value="claimed">Sudah Diklaim</option><option value="unclaimed">Belum Diklaim</option></select>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Kode Lisensi</th><th>Paket</th><th>Email</th><th>Kuota Terpakai</th><th>Aksi</th></tr></thead>
                        <tbody id="admin-license-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="app-modal" class="modal"><div class="modal-content"><div class="modal-header"><h1 id="modal-title"></h1><span class="close-button">&times;</span></div><div id="modal-body" class="modal-body"></div><div id="modal-footer" class="modal-footer"></div></div></div>
    <div id="toast-notification"></div>
    
    <script type="module">
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
        const { getAuth, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
        const { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, serverTimestamp, increment, onSnapshot, setDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
        const { getFunctions, httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js");
        
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyAnxE0CVOQGMyF0AUPtjIi_Utl3Y2vMX-w",
                authDomain: "ebook-generator-11e92.firebaseapp.com",
                projectId: "ebook-generator-11e92",
                storageBucket: "ebook-generator-11e92.appspot.com",
                messagingSenderId: "892611289187",
                appId: "1:892611289187:web:e094185ed5873f409f1856"
            };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const functions = getFunctions(app, "asia-southeast1"); 
            const generateEbookContent = httpsCallable(functions, 'generateEbookContent');

            const TIER_CONFIG = {
                'coba-coba': { name: 'Coba-coba', quota: 3 }, 'pemula': { name: 'Pemula', quota: 100 },
                'kreator': { name: 'Kreator', quota: 1000 }, 'tertinggi': { name: 'Tertinggi', quota: 10000 }
            };

            let currentUserData = null;
            let ebookQueue = [];
            let isProcessing = false;

            const loadingView = document.getElementById('loading-view');
            const authView = document.getElementById('auth-view');
            const authViewContainer = document.querySelector('#auth-view .auth-container');
            const appView = document.getElementById('app-view');
            const mainContainer = document.getElementById('main-container');
            const adminView = document.getElementById('admin-view');
            const claimLicenseView = document.getElementById('claim-license-view');
            const authStatus = document.getElementById('auth-status');
            const adminAreaBtn = document.getElementById('admin-area-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const logoutBtnClaim = document.getElementById('logout-btn-claim');
            const activeUserEmail = document.getElementById('active-user-email');
            const activeUserTier = document.getElementById('active-user-tier');
            const activeUserQuota = document.getElementById('active-user-quota');
            const topicInput = document.getElementById('topic');
            const styleSelect = document.getElementById('style');
            const personaSelect = document.getElementById('persona');
            const addToQueueBtn = document.getElementById('add-to-queue-btn');
            const queueTableBody = document.getElementById('queue-table-body');
            const processQueueBtn = document.getElementById('process-queue-btn');
            const generatorUi = document.getElementById('generator-ui');
            const quotaLimitView = document.getElementById('quota-limit-view');
            const appModal = document.getElementById('app-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            const modalCloseBtn = document.querySelector('.close-button');
            const toastNotification = document.getElementById('toast-notification');
            const backToAppBtn = document.getElementById('back-to-app-btn');
            const createLicenseForm = document.getElementById('create-license-form');
            const newLicenseKeyInput = document.getElementById('new-license-key');
            const newLicenseTierSelect = document.getElementById('new-license-tier');
            const adminSearchInput = document.getElementById('admin-search-input');
            const adminFilterSelect = document.getElementById('admin-filter-select');
            const adminLicenseTableBody = document.getElementById('admin-license-table-body');
            let unsubscribeAdminListener = null;
            let allLicensesCache = [];

            let isProcessingSignInLink = isSignInWithEmailLink(auth, window.location.href);

            function showView(viewId) {
                ['loading-view', 'auth-view', 'app-view', 'claim-license-view'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(viewId).classList.remove('hidden');
            }
            
            function renderLoginForm() {
                authViewContainer.innerHTML = `
                    <h2 class="app-header" style="margin-bottom: 1rem;">Masuk atau Daftar</h2>
                    <p style="text-align:center; color: var(--subtle-text); margin-bottom: 1.5rem;">Masukkan email Anda. Kami akan mengirimkan tautan masuk yang aman, tidak perlu kata sandi.</p>
                    <form id="login-form" class="auth-form">
                        <input type="email" id="login-email" placeholder="contoh@email.com" required>
                        <button type="submit" id="login-btn" class="btn" style="background-color: var(--primary-color);">Kirim Tautan Masuk</button>
                    </form>
                    <a href="https://wa.link/96qgxr" target="_blank" class="btn" style="background-color: var(--green-color); margin-top: 0.5rem;">Daftar / Beli Lisensi</a>
                    <p id="auth-error-msg" style="color: var(--red-color); text-align: center; margin-top: 1rem; min-height: 1.25rem;"></p>
                `;
                document.getElementById('login-form').addEventListener('submit', handleLoginRequest);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    isProcessingSignInLink = false;
                    authStatus.textContent = `Autentikasi berhasil sebagai ${user.email}. Memeriksa lisensi...`;
                    const userData = await fetchUserDataByEmail(user.email);
                    if (userData) {
                        await handleUserLogin(userData);
                        showView('app-view');
                    } else {
                        showView('claim-license-view');
                    }
                } else {
                    if (isProcessingSignInLink) { return; } 
                    else {
                        currentUserData = null;
                        renderLoginForm();
                        showView('auth-view');
                    }
                }
            });
            
            async function handleSignInLink() {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) { email = window.prompt('Untuk keamanan, silakan masukkan kembali email Anda.'); }
                if (!email) {
                    isProcessingSignInLink = false;
                    renderLoginForm();
                    showView('auth-view');
                    return;
                }
                try {
                    authStatus.textContent = 'Mengonfirmasi tautan masuk...';
                    await signInWithEmailLink(auth, email, window.location.href);
                    window.localStorage.removeItem('emailForSignIn');
                    window.history.replaceState(null, '', window.location.pathname);
                } catch (error) {
                    isProcessingSignInLink = false;
                    renderLoginForm();
                    document.getElementById('auth-error-msg').textContent = 'Gagal masuk: Tautan tidak valid atau sudah kedaluwarsa.';
                    showView('auth-view');
                }
            }
            
            async function handleLoginRequest(e) {
                e.preventDefault();
                const loginEmailInput = document.getElementById('login-email');
                const loginBtn = document.getElementById('login-btn');
                const email = loginEmailInput.value;
                loginBtn.disabled = true;
                loginBtn.textContent = 'Mengirim...';
                
                const actionCodeSettings = {
                    url: window.location.origin + window.location.pathname,
                    handleCodeInApp: true
                };

                try {
                    await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                    window.localStorage.setItem('emailForSignIn', email);
                    authViewContainer.innerHTML = `
                        <div class="app-header" style="text-align: center;">
                            <i data-lucide="mail-check" style="color: var(--green-color); width: 48px; height: 48px; margin-bottom: 1rem; display: inline-block;"></i>
                            <h1>Tautan Terkirim!</h1>
                        </div>
                        <p style="text-align:center; color: var(--subtle-text);">Kami telah mengirimkan tautan masuk ke:</p>
                        <p style="text-align:center; font-weight: 600; margin-bottom: 1.5rem; word-break: break-all;">${email}</p>
                        <p style="text-align:center; color: var(--subtle-text);">Silakan periksa kotak masuk (dan folder spam) Anda untuk melanjutkan.</p>
                    `;
                    lucide.createIcons();
                } catch (error) {
                    document.getElementById('auth-error-msg').textContent = `Gagal mengirim tautan: ${error.message}`;
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Kirim Tautan Masuk';
                }
            }

            document.getElementById('claim-license-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const key = document.getElementById('license-key-input').value.trim();
                const user = auth.currentUser;
                if (!key || !user) return;
                const licenseRef = doc(db, "licenses", key);
                const licenseSnap = await getDoc(licenseRef);
                if (!licenseSnap.exists() || licenseSnap.data().claimedByEmail) {
                    showToast('Kunci lisensi tidak valid atau sudah digunakan.', 'error');
                    return;
                }
                try {
                    await updateDoc(licenseRef, { claimedByEmail: user.email, claimedAt: serverTimestamp() });
                    showToast('Lisensi berhasil diklaim! Memuat ulang...', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (error) {
                    showToast(`Gagal mengklaim lisensi: ${error.message}`, 'error');
                }
            });

            const handleLogout = () => { signOut(auth).catch(error => console.error('Logout error', error)); };
            logoutBtn.addEventListener('click', handleLogout);
            logoutBtnClaim.addEventListener('click', handleLogout);

            async function fetchUserDataByEmail(email) {
                const q = query(collection(db, "licenses"), where("claimedByEmail", "==", email));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return null;
                const docSnap = querySnapshot.docs[0];
                return { id: docSnap.id, ...docSnap.data() };
            }

            async function handleUserLogin(userData) {
                const now = new Date();
                const resetDate = userData.quotaResetDate?.toDate();
                if (!resetDate || now >= resetDate) {
                    const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    await updateDoc(doc(db, "licenses", userData.id), { quotaUsed: 0, quotaResetDate: nextMonth });
                    userData.quotaUsed = 0;
                }
                currentUserData = userData;
                updateUI();
            }

            function updateUI() {
                if (!currentUserData) return;
                const tierInfo = TIER_CONFIG[currentUserData.tier] || { name: 'Unknown', quota: 0 };
                const remainingQuota = tierInfo.quota - (currentUserData.quotaUsed || 0);
                activeUserEmail.textContent = currentUserData.claimedByEmail;
                activeUserTier.textContent = tierInfo.name;
                activeUserQuota.textContent = remainingQuota;
                const hasQuota = remainingQuota > 0;
                generatorUi.classList.toggle('hidden', !hasQuota);
                quotaLimitView.classList.toggle('hidden', hasQuota);
                if (currentUserData.claimedByEmail === 'poopandastore@gmail.com') {
                    adminAreaBtn.classList.remove('hidden');
                } else {
                    adminAreaBtn.classList.add('hidden');
                }
                renderQueueTable();
            }

            adminAreaBtn.addEventListener('click', () => {
                mainContainer.classList.add('hidden');
                adminView.classList.remove('hidden');
                loadAdminData();
            });
            backToAppBtn.addEventListener('click', () => {
                adminView.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                if (unsubscribeAdminListener) { unsubscribeAdminListener(); unsubscribeAdminListener = null; }
            });
            function loadAdminData() {
                const q = query(collection(db, "licenses"));
                unsubscribeAdminListener = onSnapshot(q, (querySnapshot) => {
                    allLicensesCache = [];
                    querySnapshot.forEach((doc) => { allLicensesCache.push({ id: doc.id, ...doc.data() }); });
                    filterAndRenderAdminTable();
                });
            }
            function filterAndRenderAdminTable() {
                const searchTerm = adminSearchInput.value.toLowerCase();
                const filterType = adminFilterSelect.value;
                const filtered = allLicensesCache.filter(lic => {
                    const matchesSearch = lic.id.toLowerCase().includes(searchTerm) || (lic.claimedByEmail && lic.claimedByEmail.toLowerCase().includes(searchTerm));
                    const matchesFilter = (filterType === 'all') || (filterType === 'claimed' && lic.claimedByEmail) || (filterType === 'unclaimed' && !lic.claimedByEmail);
                    return matchesSearch && matchesFilter;
                });
                renderAdminTable(filtered);
            }
            adminSearchInput.addEventListener('input', filterAndRenderAdminTable);
            adminFilterSelect.addEventListener('change', filterAndRenderAdminTable);
            function renderAdminTable(licenses) {
                adminLicenseTableBody.innerHTML = licenses.map(lic => `
                    <tr>
                        <td>${lic.id}</td>
                        <td style="text-transform: capitalize;">${lic.tier || 'N/A'}</td>
                        <td>${lic.claimedByEmail || '-'}</td>
                        <td>${lic.quotaUsed || 0} / ${TIER_CONFIG[lic.tier]?.quota || '?'}</td>
                        <td>
                            <button class="btn edit-license-btn" data-id="${lic.id}" style="font-size:0.8rem;padding:4px 8px;background-color:var(--blue-color)">Edit</button>
                            <button class="btn delete-license-btn" data-id="${lic.id}" style="font-size:0.8rem;padding:4px 8px;background-color:var(--red-color)">Hapus</button>
                        </td>
                    </tr>`).join('');
                document.querySelectorAll('.edit-license-btn').forEach(btn => btn.addEventListener('click', handleEditLicense));
                document.querySelectorAll('.delete-license-btn').forEach(btn => btn.addEventListener('click', handleDeleteLicense));
            }
            createLicenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newKey = newLicenseKeyInput.value.trim();
                if (!newKey) return;
                try {
                    await setDoc(doc(db, "licenses", newKey), {
                        tier: newLicenseTierSelect.value, claimedByEmail: null, claimedAt: null,
                        quotaUsed: 0, quotaResetDate: null
                    });
                    showToast(`Lisensi "${newKey}" berhasil dibuat.`, 'success');
                    newLicenseKeyInput.value = '';
                } catch (error) { showToast(`Error: ${error.message}`, 'error'); }
            });
            function handleEditLicense(e) {
                const licenseId = e.target.dataset.id;
                const licenseData = allLicensesCache.find(lic => lic.id === licenseId);
                if (!licenseData) return;
                const tierOptions = Object.keys(TIER_CONFIG).map(key => `<option value="${key}" ${licenseData.tier === key ? 'selected' : ''}>${TIER_CONFIG[key].name}</option>`).join('');
                modalTitle.textContent = "Edit Lisensi";
                modalBody.innerHTML = `<form id="edit-license-modal-form" class="auth-form"><label>ID Lisensi: <strong>${licenseId}</strong></label><label>Paket Lisensi</label><select id="edit-license-tier">${tierOptions}</select><label>Email Pengguna (kosongkan untuk membebaskan)</label><input type="email" id="edit-license-email" value="${licenseData.claimedByEmail || ''}" placeholder="Email pengguna baru..."></form>`;
                modalFooter.innerHTML = `<button id="cancel-edit-btn" class="btn" style="background-color: var(--subtle-text)">Batal</button><button id="save-edit-license-btn" class="btn" style="background-color: var(--green-color)">Simpan</button>`;
                appModal.style.display = 'flex';
                document.getElementById('save-edit-license-btn').onclick = async () => {
                    const newTier = document.getElementById('edit-license-tier').value;
                    const newEmail = document.getElementById('edit-license-email').value.trim().toLowerCase() || null;
                    try {
                        await updateDoc(doc(db, "licenses", licenseId), { tier: newTier, claimedByEmail: newEmail });
                        showToast('Lisensi berhasil diperbarui.', 'success');
                        appModal.style.display = 'none';
                    } catch (error) { showToast(`Gagal memperbarui: ${error.message}`, 'error'); }
                };
                document.getElementById('cancel-edit-btn').onclick = () => appModal.style.display = 'none';
            }
            function handleDeleteLicense(e) {
                const id = e.target.dataset.id;
                modalTitle.textContent = "Konfirmasi Hapus";
                modalBody.innerHTML = `<p>Apakah Anda yakin ingin menghapus lisensi <strong>${id}</strong> secara permanen?</p>`;
                modalFooter.innerHTML = `<button id="cancel-delete-btn" class="btn" style="background-color: var(--subtle-text)">Batal</button><button id="confirm-delete-btn" class="btn" style="background-color: var(--red-color)">Ya, Hapus</button>`;
                appModal.style.display = 'flex';
                document.getElementById('confirm-delete-btn').onclick = async () => {
                    try {
                        await deleteDoc(doc(db, "licenses", id));
                        showToast(`Lisensi ${id} berhasil dihapus.`, 'success');
                        appModal.style.display = 'none';
                    } catch (error) { showToast(`Gagal menghapus: ${error.message}`, 'error'); }
                };
                document.getElementById('cancel-delete-btn').onclick = () => appModal.style.display = 'none';
            }

            async function callGenerateApi(prompt) { /* ...Fungsi ini tetap sama... */ }
            function addTopicToQueue() { /* ...Fungsi ini tetap sama... */ }
            function renderQueueTable() { /* ...Fungsi ini tetap sama... */ }
            async function processQueue() { /* ...Fungsi ini tetap sama... */ }
            function updateItemStatus(id, status) { /* ...Fungsi ini tetap sama... */ }
            function parseOutline(text) { /* ...Fungsi ini tetap sama... */ }
            function renderEbookToHtml(title, ebookData) { /* ...Fungsi ini tetap sama... */ }
            function generateFallbackEbook(topic, errorMessage) { /* ...Fungsi ini tetap sama... */ }
            function showEbookInModal(item) { /* ...Fungsi ini tetap sama... */ }
            function showToast(message, type = 'success') { /* ...Fungsi ini tetap sama... */ }

            async function init() {
                showView('loading-view');
                authStatus.textContent = 'Memeriksa status login...';
                if (isProcessingSignInLink) { await handleSignInLink(); }
                lucide.createIcons();
            }
            
            modalCloseBtn.addEventListener('click', () => appModal.style.display = 'none');
            window.addEventListener('click', (event) => { if (event.target == appModal) appModal.style.display = 'none'; });
            
            init();

        } catch (e) {
            console.error("Aplikasi gagal diinisialisasi:", e);
            document.body.innerHTML = `<div class="auth-container"><h2 class="app-header" style="color:var(--red-color)">Error Kritis</h2><p style="text-align:center;">Aplikasi tidak dapat dimuat. ${e.message}</p></div>`;
        }
    </script>
</body>
</html>
