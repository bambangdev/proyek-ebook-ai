<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pembuat Ebook AI (Aman)</title>
    <!-- Google Fonts & Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* CSS Lengkap (Sama seperti sebelumnya, tidak diubah) */
        :root {
            --primary-color: #4f46e5; --primary-hover: #4338ca; --green-color: #16a34a;
            --red-color: #ef4444; --orange-color: #f97316; --blue-color: #3b82f6;
            --background-color: #f1f5f9; --text-color: #334155; --subtle-text: #64748b;
            --border-color: #e5e7eb; --card-bg: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 1rem; box-sizing: border-box; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .app-container, .auth-container, .admin-container { background-color: var(--card-bg); width: 100%; max-width: 64rem; margin-left: auto; margin-right: auto; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .auth-container { max-width: 28rem; }
        .auth-form { display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        .app-header { text-align: center; margin-bottom: 1.5rem; }
        .app-header h1 { font-size: 1.875rem; font-weight: 700; }
        .app-header p { color: var(--subtle-text); margin-top: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
        @media (min-width: 1024px) { .form-grid { grid-template-columns: 2fr 1fr 1fr 1fr; } }
        .form-grid input, .form-grid select, .form-grid button { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        .btn { border: none; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); transition: background-color 0.2s; padding: 0.6rem 1rem; height: 42px; }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .user-info { font-size: 0.8rem; color: var(--subtle-text); margin-bottom: 1rem; text-align: left; word-break: break-all;}
        .hidden { display: none !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--card-bg); padding: 20px; border-radius: 0.75rem; width: 90%; max-width: 500px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-footer { display: flex; justify-content: flex-end; margin-top: 1rem; gap: 0.75rem; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .table-container { overflow-x: auto; margin-top: 1rem; max-height: 60vh; }
        table { width: 100%; min-width: 700px; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        thead { background-color: #f9fafb; position: sticky; top: 0; z-index: 10;}
        #toast-notification { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; opacity: 0; transition: visibility 0.5s, opacity 0.5s, bottom 0.5s; }
        #toast-notification.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast-notification.success { background-color: var(--green-color); }
        #toast-notification.error { background-color: var(--red-color); }
    </style>
</head>
<body>

    <!-- Container Aplikasi - statusnya diatur oleh JS -->
    <div id="app-root">
        <!-- Tampilan Loading Awal -->
        <div id="loading-view" class="auth-container fade-in">
            <h2 class="app-header">Memuat Aplikasi...</h2>
            <p id="auth-status" style="text-align: center; color: var(--subtle-text);"></p>
        </div>

        <!-- Tampilan Autentikasi -->
        <div id="auth-view" class="hidden">
            <div class="auth-container">
                <!-- Konten akan diisi oleh JS, baik form login atau pesan sukses -->
            </div>
        </div>
        
        <!-- Tampilan Klaim Lisensi (Untuk pengguna baru) -->
        <div id="claim-license-view" class="hidden">
            <div class="auth-container">
                <h2 class="app-header">Selamat Datang!</h2>
                <p style="text-align: center; color: var(--subtle-text);">Akun Anda belum aktif. Silakan masukkan kunci lisensi yang Anda dapatkan dari admin.</p>
                <form id="claim-license-form" class="auth-form" style="margin-top: 1.5rem;">
                    <input type="text" id="license-key-input" placeholder="Masukkan Kunci Lisensi" required>
                    <button type="submit" class="btn" style="background-color: var(--green-color);">Aktifkan Akun</button>
                </form>
                 <button id="logout-btn-claim" class="btn" style="background-color: var(--red-color); width: 100%; margin-top: 1rem;">Keluar</button>
            </div>
        </div>

        <!-- Tampilan Aplikasi Utama -->
        <div id="app-view" class="hidden">
            <div id="main-container" class="app-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap;">
                     <div class="user-info">
                        <p>Email: <strong id="active-user-email"></strong></p>
                        <p>Paket Aktif: <strong id="active-user-tier" style="text-transform: capitalize;"></strong></p>
                        <p>Sisa Kuota Bulan Ini: <strong id="active-user-quota"></strong> ebook</p>
                    </div>
                    <div>
                        <button id="logout-btn" class="btn" style="background-color: var(--red-color);">Keluar</button>
                    </div>
                </div>
                <div class="app-header">
                    <h1>Ebook Generator AI</h1>
                </div>
                <div id="generator-ui">
                    <div class="form-grid">
                        <input type="text" id="topic" placeholder="Masukkan topik ebook...">
                        <select id="style"><option value="Santai dan Menarik">Gaya: Santai</option><option value="Formal dan Edukatif">Gaya: Formal</option><option value="Inspiratif dan Motivasi">Gaya: Motivasi</option></select>
                        <select id="persona"><option value="Pakar di Bidangnya">Persona: Pakar</option><option value="Jurnalis Investigatif">Persona: Jurnalis</option><option value="Pencerita yang Handal">Persona: Pencerita</option></select>
                        <button id="add-to-queue-btn" class="btn" style="background-color: var(--blue-color);"><i data-lucide="plus-circle"></i><span>Tambah</span></button>
                    </div>
                    <h2>Antrean Ebook</h2>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Topik</th><th>Gaya</th><th>Persona</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody id="queue-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="quota-limit-view" class="hidden" style="text-align: center; padding: 2rem; border: 2px dashed var(--border-color); border-radius: 0.5rem;">
                    <h2>Kuota Habis</h2>
                    <p>Kuota ebook Anda untuk bulan ini telah habis.</p>
                </div>
                 <div style="margin-top: 2rem;"><button id="process-queue-btn" class="btn" style="background-color: var(--primary-color);" disabled><i data-lucide="play-circle"></i><span>Mulai Proses Antrean</span></button></div>
            </div>
        </div>
    </div>
    
    <div id="app-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 id="modal-title"></h1>
                <span class="close-button">&times;</span>
            </div>
            <div id="modal-body"></div>
            <div id="modal-footer"></div>
        </div>
    </div>

    <div id="toast-notification"></div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // --- Impor SDK Firebase yang Diperlukan ---
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
        const { getAuth, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
        const { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, serverTimestamp, setDoc, increment } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
        const { getFunctions, httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js");
        
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyAnxE0CVOQGMyF0AUPtjIi_Utl3Y2vMX-w",
                authDomain: "ebook-generator-11e92.firebaseapp.com",
                projectId: "ebook-generator-11e92",
                storageBucket: "ebook-generator-11e92.appspot.com",
                messagingSenderId: "892611289187",
                appId: "1:892611289187:web:e094185ed5873f409f1856"
            };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const functions = getFunctions(app, "asia-southeast1"); 

            const generateEbookContent = httpsCallable(functions, 'generateEbookContent');

            const TIER_CONFIG = {
                'coba-coba': { name: 'Coba-coba', quota: 3 }, 'pemula': { name: 'Pemula', quota: 100 },
                'kreator': { name: 'Kreator', quota: 1000 }, 'tertinggi': { name: 'Tertinggi', quota: 10000 }
            };

            let currentUserData = null;
            let ebookQueue = [];
            let isProcessing = false;

            // DOM Elements
            const loadingView = document.getElementById('loading-view');
            const authView = document.getElementById('auth-view');
            const authViewContainer = document.querySelector('#auth-view .auth-container');
            const appView = document.getElementById('app-view');
            const claimLicenseView = document.getElementById('claim-license-view');
            const authStatus = document.getElementById('auth-status');
            const logoutBtn = document.getElementById('logout-btn');
            const logoutBtnClaim = document.getElementById('logout-btn-claim');
            const activeUserEmail = document.getElementById('active-user-email');
            const activeUserTier = document.getElementById('active-user-tier');
            const activeUserQuota = document.getElementById('active-user-quota');
            const topicInput = document.getElementById('topic');
            const styleSelect = document.getElementById('style');
            const personaSelect = document.getElementById('persona');
            const addToQueueBtn = document.getElementById('add-to-queue-btn');
            const queueTableBody = document.getElementById('queue-table-body');
            const processQueueBtn = document.getElementById('process-queue-btn');
            const generatorUi = document.getElementById('generator-ui');
            const quotaLimitView = document.getElementById('quota-limit-view');
            const appModal = document.getElementById('app-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            const modalCloseBtn = document.querySelector('.close-button');
            const toastNotification = document.getElementById('toast-notification');

            let isProcessingSignInLink = isSignInWithEmailLink(auth, window.location.href);

            function showView(viewId) {
                ['loading-view', 'auth-view', 'app-view', 'claim-license-view'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(viewId).classList.remove('hidden');
            }
            
            function renderLoginForm() {
                authViewContainer.innerHTML = `
                    <h2 class="app-header" style="margin-bottom: 1rem;">Masuk atau Daftar</h2>
                    <p style="text-align:center; color: var(--subtle-text); margin-bottom: 1.5rem;">Masukkan email Anda. Kami akan mengirimkan tautan masuk yang aman, tidak perlu kata sandi.</p>
                    <form id="login-form" class="auth-form">
                        <input type="email" id="login-email" placeholder="contoh@email.com" required>
                        <button type="submit" id="login-btn" class="btn" style="background-color: var(--primary-color);">Kirim Tautan Masuk</button>
                    </form>
                    <p id="auth-error-msg" style="color: var(--red-color); text-align: center; margin-top: 1rem; min-height: 1.25rem;"></p>
                `;
                document.getElementById('login-form').addEventListener('submit', handleLoginRequest);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    isProcessingSignInLink = false;
                    authStatus.textContent = `Autentikasi berhasil sebagai ${user.email}. Memeriksa lisensi...`;
                    const userData = await fetchUserDataByEmail(user.email);
                    if (userData) {
                        await handleUserLogin(userData);
                        showView('app-view');
                    } else {
                        showView('claim-license-view');
                    }
                } else {
                    if (isProcessingSignInLink) {
                        return;
                    } else {
                        currentUserData = null;
                        renderLoginForm();
                        showView('auth-view');
                    }
                }
            });
            
            async function handleSignInLink() {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    email = window.prompt('Untuk keamanan, silakan masukkan kembali email Anda.');
                }
                if (!email) { // Jika pengguna membatalkan prompt
                    isProcessingSignInLink = false;
                    renderLoginForm();
                    showView('auth-view');
                    return;
                }
                try {
                    authStatus.textContent = 'Mengonfirmasi tautan masuk...';
                    await signInWithEmailLink(auth, email, window.location.href);
                    window.localStorage.removeItem('emailForSignIn');
                    window.history.replaceState(null, '', window.location.pathname);
                } catch (error) {
                    isProcessingSignInLink = false;
                    renderLoginForm();
                    document.getElementById('auth-error-msg').textContent = 'Gagal masuk: Tautan tidak valid atau sudah kedaluwarsa.';
                    showView('auth-view');
                }
            }
            
            async function handleLoginRequest(e) {
                e.preventDefault();
                const loginEmailInput = document.getElementById('login-email');
                const loginBtn = document.getElementById('login-btn');
                const email = loginEmailInput.value;
                loginBtn.disabled = true;
                loginBtn.textContent = 'Mengirim...';
                
                // --- PERBAIKAN DI SINI ---
                const actionCodeSettings = {
                    url: window.location.origin + window.location.pathname,
                    handleCodeInApp: true
                };

                try {
                    await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                    window.localStorage.setItem('emailForSignIn', email);
                    authViewContainer.innerHTML = `
                        <div class="app-header" style="text-align: center;">
                            <i data-lucide="mail-check" style="color: var(--green-color); width: 48px; height: 48px; margin-bottom: 1rem; display: inline-block;"></i>
                            <h1>Tautan Terkirim!</h1>
                        </div>
                        <p style="text-align:center; color: var(--subtle-text);">Kami telah mengirimkan tautan masuk ke:</p>
                        <p style="text-align:center; font-weight: 600; margin-bottom: 1.5rem; word-break: break-all;">${email}</p>
                        <p style="text-align:center; color: var(--subtle-text);">Silakan periksa kotak masuk (dan folder spam) Anda untuk melanjutkan.</p>
                    `;
                    lucide.createIcons();
                } catch (error) {
                    document.getElementById('auth-error-msg').textContent = `Gagal mengirim tautan: ${error.message}`;
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Kirim Tautan Masuk';
                }
            }

            document.getElementById('claim-license-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const key = document.getElementById('license-key-input').value.trim();
                const user = auth.currentUser;
                if (!key || !user) return;

                const licenseRef = doc(db, "licenses", key);
                const licenseSnap = await getDoc(licenseRef);

                if (!licenseSnap.exists() || licenseSnap.data().claimedByEmail) {
                    showToast('Kunci lisensi tidak valid atau sudah digunakan.', 'error');
                    return;
                }
                
                try {
                    await updateDoc(licenseRef, {
                        claimedByEmail: user.email,
                        claimedAt: serverTimestamp()
                    });
                    showToast('Lisensi berhasil diklaim! Memuat ulang...', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (error) {
                    showToast(`Gagal mengklaim lisensi: ${error.message}`, 'error');
                }
            });

            const handleLogout = () => { signOut(auth).catch(error => console.error('Logout error', error)); };
            logoutBtn.addEventListener('click', handleLogout);
            logoutBtnClaim.addEventListener('click', handleLogout);

            async function fetchUserDataByEmail(email) {
                const q = query(collection(db, "licenses"), where("claimedByEmail", "==", email));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return null;
                const docSnap = querySnapshot.docs[0];
                return { id: docSnap.id, ...docSnap.data() };
            }

            async function handleUserLogin(userData) {
                const now = new Date();
                const resetDate = userData.quotaResetDate?.toDate();
                if (!resetDate || now >= resetDate) {
                    const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    await updateDoc(doc(db, "licenses", userData.id), { quotaUsed: 0, quotaResetDate: nextMonth });
                    userData.quotaUsed = 0;
                }
                currentUserData = userData;
                updateUI();
            }

            function updateUI() {
                const tierInfo = TIER_CONFIG[currentUserData.tier] || { name: 'Unknown', quota: 0 };
                const remainingQuota = tierInfo.quota - (currentUserData.quotaUsed || 0);
                activeUserEmail.textContent = currentUserData.claimedByEmail;
                activeUserTier.textContent = tierInfo.name;
                activeUserQuota.textContent = remainingQuota;
                const hasQuota = remainingQuota > 0;
                generatorUi.classList.toggle('hidden', !hasQuota);
                quotaLimitView.classList.toggle('hidden', hasQuota);
                renderQueueTable();
            }

            async function callGenerateApi(prompt) {
                try {
                    const result = await generateEbookContent({ prompt });
                    return result.data;
                } catch (error) {
                    console.error("Error memanggil Cloud Function:", error);
                    throw new Error(`Gagal menghubungi server: ${error.message}`);
                }
            }
            
            function addTopicToQueue() {
                const topic = topicInput.value.trim();
                if (!topic) {
                    showToast('Topik tidak boleh kosong.', 'error');
                    return;
                }
                ebookQueue.push({ id: Date.now(), topic, style: styleSelect.value, persona: personaSelect.value, status: 'Menunggu', htmlContent: null });
                topicInput.value = '';
                renderQueueTable();
            }
            
            function renderQueueTable() {
                processQueueBtn.disabled = isProcessing || ebookQueue.length === 0;
                queueTableBody.innerHTML = ebookQueue.map(item => `
                    <tr>
                        <td>${item.topic}</td>
                        <td>${item.style}</td>
                        <td>${item.persona}</td>
                        <td>${item.status}</td>
                        <td>
                            ${item.status === 'Selesai' ? `<button class="btn view-result-btn" data-id="${item.id}" style="font-size: 0.8rem; padding: 4px 8px; background-color: var(--green-color);">Lihat</button>` : ''}
                            ${item.status.includes('Gagal') ? `<button class="btn view-result-btn" data-id="${item.id}" style="font-size: 0.8rem; padding: 4px 8px; background-color: var(--red-color);">Error</button>` : ''}
                        </td>
                    </tr>`).join('');
                document.querySelectorAll('.view-result-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const item = ebookQueue.find(q => q.id === parseInt(e.currentTarget.dataset.id));
                        if (item) showEbookInModal(item);
                    };
                });
            }

            async function processQueue() { 
                isProcessing = true;
                renderQueueTable();
                for (const item of ebookQueue) {
                    if (item.status === 'Menunggu') {
                        try {
                            const remainingQuota = (TIER_CONFIG[currentUserData.tier]?.quota || 0) - currentUserData.quotaUsed;
                            if(remainingQuota <= 0) {
                                showToast('Kuota Anda habis.', 'error');
                                throw new Error("Kuota habis");
                            }
                            updateItemStatus(item.id, 'Membuat kerangka...');
                            const promptOutline = `Buatkan outline TEKS SAJA untuk ebook dengan topik "${item.topic}". Beri judul yang menarik. Buat 5 bab. Format jawaban harus seperti ini, tanpa teks lain:\n**Judul:** [Judul Ebook Di Sini]\n**Bab 1:** [Judul Bab 1]\n...`;
                            const outlineResult = await callGenerateApi(promptOutline);
                            const { title, chapters } = parseOutline(outlineResult.text);
                            let ebookData = [];
                            for (let i = 0; i < chapters.length; i++) {
                                updateItemStatus(item.id, `Menulis Bab ${i + 1}/${chapters.length}...`);
                                const contentPrompt = `Anda adalah seorang penulis dengan persona sebagai ${item.persona}. Tulis konten untuk bab buku berjudul "${chapters[i]}" dari ebook bertopik "${item.topic}". Gunakan gaya bahasa ${item.style}. Panjang sekitar 400-500 kata.`;
                                const contentResult = await callGenerateApi(contentPrompt);
                                ebookData.push({ title: chapters[i], content: contentResult.text });
                            }
                            item.htmlContent = renderEbookToHtml(title, ebookData);
                            await updateDoc(doc(db, "licenses", currentUserData.id), { quotaUsed: increment(1) });
                            currentUserData.quotaUsed++;
                            updateItemStatus(item.id, 'Selesai');
                            updateUI();
                        } catch (error) {
                            console.error(`Gagal membuat ebook untuk "${item.topic}":`, error);
                            item.htmlContent = generateFallbackEbook(item.topic, error.message);
                            updateItemStatus(item.id, `Gagal`);
                        }
                    }
                }
                isProcessing = false;
                renderQueueTable();
                showToast(`Proses antrean selesai!`, 'success');
            }
            
            function updateItemStatus(id, status) {
                const item = ebookQueue.find(q => q.id === id);
                if (item) item.status = status;
                renderQueueTable();
            }

            function parseOutline(text) { 
                if (!text || typeof text !== 'string') throw new Error("Respons AI tidak valid.");
                const lines = text.split('\n').filter(line => line.trim() !== '');
                let title = "Judul Ebook";
                const titleLine = lines.find(line => line.match(/\*\*?Judul\*\*?:\s*/i));
                if (titleLine) title = titleLine.replace(/\*\*?Judul\*\*?:\s*/i, '').trim();
                const chapters = lines.filter(line => line.match(/\*\*?Bab\s*\d*:/i)).map(line => line.replace(/\*\*?Bab\s*\d*:\s*/i, '').trim());
                if (chapters.length === 0) throw new Error("Gagal membuat outline bab dari respons AI.");
                return { title, chapters };
            }
            
            function renderEbookToHtml(title, ebookData) { 
                let html = `<h1 class="ebook-title">${title}</h1>`;
                ebookData.forEach((chapter, index) => {
                    html += `<div class="ebook-chapter"><h2>Bab ${index + 1}: ${chapter.title}</h2><p>${chapter.content.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</p></div>`;
                });
                return html;
            }
            
            function generateFallbackEbook(topic, errorMessage) { return `<h1>Gagal Membuat Ebook: ${topic}</h1><p><b>Detail Kesalahan:</b> ${errorMessage}</p>`; }

            function showEbookInModal(item) { 
                modalTitle.textContent = item.status.includes('Gagal') ? "Detail Kegagalan" : `Ebook: ${item.topic}`;
                modalBody.innerHTML = `<div id="modal-ebook-content">${item.htmlContent}</div>`;
                modalFooter.innerHTML = `<button id="modal-save-docx-btn" class="btn" style="background-color: var(--orange-color);"><i data-lucide="file-text"></i><span>Simpan .docx</span></button><button id="modal-save-pdf-btn" class="btn" style="background-color: var(--green-color);"><i data-lucide="download"></i><span>Simpan PDF</span></button>`;
                lucide.createIcons();
                document.getElementById('modal-save-pdf-btn').onclick = () => { html2pdf().from(document.getElementById('modal-ebook-content')).save(`${item.topic}.pdf`); };
                document.getElementById('modal-save-docx-btn').onclick = () => { saveAs(htmlDocx.asBlob(`<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${item.htmlContent}</body></html>`), `${item.topic}.docx`); };
                appModal.style.display = 'flex';
            }

            function showToast(message, type = 'success') {
                toastNotification.textContent = message;
                toastNotification.className = 'show ' + type;
                setTimeout(() => { toastNotification.className = toastNotification.className.replace('show', ''); }, 3000);
            }

            async function init() {
                showView('loading-view');
                authStatus.textContent = 'Memeriksa status login...';
                if (isProcessingSignInLink) {
                    await handleSignInLink();
                }
                lucide.createIcons();
            }
            
            // Event Listeners
            addToQueueBtn.addEventListener('click', addTopicToQueue);
            processQueueBtn.addEventListener('click', processQueue);
            if(modalCloseBtn) modalCloseBtn.addEventListener('click', () => appModal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target == appModal) appModal.style.display = 'none';
            });
            
            init();

        } catch (e) {
            console.error("Aplikasi gagal diinisialisasi:", e);
            document.body.innerHTML = `<div class="auth-container"><h2 class="app-header" style="color:var(--red-color)">Error Kritis</h2><p style="text-align:center;">Aplikasi tidak dapat dimuat. ${e.message}</p></div>`;
        }
    </script>
</body>
</html>
