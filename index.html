<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pembuat Ebook AI</title>
    <!-- Google Fonts & Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* CSS Lengkap di sini agar mudah disalin */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; margin: 0; padding: 1rem; box-sizing: border-box; }
        .app-container, .auth-container { background-color: #fff; max-width: 64rem; margin-left: auto; margin-right: auto; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .auth-container { max-width: 28rem; margin-top: 5rem; }
        .app-header { text-align: center; margin-bottom: 1.5rem; }
        .app-header h1 { font-size: 1.875rem; font-weight: 700; }
        .app-header p { color: #64748b; margin-top: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
        @media (min-width: 1024px) { .form-grid { grid-template-columns: 2fr 1fr 1fr 1fr; } }
        .form-grid input, .form-grid select, .form-grid button { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        .license-form input { display: block; width: 100%; margin-bottom: 1rem; }
        .btn { border: none; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); transition: background-color 0.2s; padding: 0.6rem 1rem; }
        .btn-blue { background-color: #3b82f6; }
        .btn-blue:hover { background-color: #2563eb; }
        .btn-indigo { background-color: #4f46e5; }
        .btn-indigo:hover { background-color: #4338ca; }
        .btn-green { background-color: #16a34a; }
        .btn-green:hover { background-color: #15803d; }
        .btn-orange { background-color: #f97316; }
        .btn-orange:hover { background-color: #ea580c; }
        .btn-red { background-color: #ef4444; }
        .btn-red:hover { background-color: #dc2626; }
        .btn-full { width: 100%; }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .table-container { overflow-x: auto; margin-top: 1rem; }
        table { width: 100%; min-width: 700px; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; text-align: left; white-space: nowrap; }
        td:first-child { white-space: normal; }
        thead { background-color: #f9fafb; }
        .ebook-container { background: white; padding: 2rem; max-width: 8.5in; margin: auto; }
        .ebook-title { font-family: 'Lora', serif; font-size: 2.8rem; font-weight: 700; text-align: center; margin-bottom: 2rem; }
        .ebook-toc h3, .ebook-chapter-title { font-family: 'Lora', serif; font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
        .ebook-toc ul { list-style-type: disc; padding-left: 1.5rem; }
        .ebook-toc li { margin-bottom: 0.5rem; }
        .ebook-chapter { margin-top: 2rem; page-break-before: always; }
        .ebook-chapter-content { font-family: 'Lora', serif; font-size: 1.1rem; line-height: 1.7; text-align: justify; }
        .ebook-chapter-content p { margin-bottom: 1rem; }
        .ebook-chapter-content p:last-child { margin-bottom: 0; }
        .spinner, .btn-spinner { border: 2px solid rgba(255, 255, 255, 0.3); width: 16px; height: 16px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; display: inline-block; }
        .status-cell .spinner { border-color: rgba(0,0,0,0.1); border-left-color: #09f; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 0.5rem; width: 90%; max-width: 900px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h1 { font-size: 1.5rem; }
        .modal-body { max-height: 70vh; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; margin-top: 1rem; gap: 0.75rem; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
        .hidden { display: none !important; }
        .user-info { font-size: 0.8rem; color: #64748b; margin-bottom: 1rem; text-align: left; word-break: break-all;}
    </style>
</head>
<body>

    <!-- Container untuk Validasi Lisensi -->
    <div id="license-view">
        <div class="auth-container">
            <h2 class="app-header">Verifikasi Lisensi</h2>
            <p id="auth-status" class="app-header" style="color:#3b82f6;">Menghubungkan ke layanan...</p>
            <form id="license-form" class="license-form">
                <input type="text" id="license-code-input" placeholder="Masukkan Kode Lisensi Anda" required disabled>
                <button type="submit" id="verify-btn" class="btn btn-indigo btn-full" disabled>
                    <span id="verify-btn-text">Verifikasi & Masuk</span>
                    <div id="verify-btn-spinner" class="btn-spinner hidden"></div>
                </button>
            </form>
            <p id="license-error" style="color: #ef4444; text-align: center; margin-top: 1rem; display: none;"></p>
        </div>
    </div>

    <!-- Container Aplikasi Utama (tersembunyi) -->
    <div id="app-view" class="hidden">
        <div id="main-container" class="app-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                 <div class="user-info">
                    <p>Kode Lisensi: <strong id="active-license-code"></strong></p>
                    <p>User ID: <span id="user-id-display"></span></p>
                </div>
                <button id="logout-btn" class="btn btn-red" style="padding: 0.5rem 1rem;">Keluar</button>
            </div>
            <div class="app-header">
                <h1>Ebook Generator AI</h1>
            </div>
            <div class="form-grid">
                <input type="text" id="topic" placeholder="Masukkan topik ebook...">
                <select id="style">
                    <option value="Santai dan Menarik">Gaya: Santai</option>
                    <option value="Formal dan Edukatif">Gaya: Formal</option>
                    <option value="Inspiratif dan Motivasi">Gaya: Motivasi</option>
                </select>
                <select id="persona">
                    <option value="Pakar di Bidangnya">Persona: Pakar</option>
                    <option value="Jurnalis Investigatif">Persona: Jurnalis</option>
                    <option value="Pencerita yang Handal">Persona: Pencerita</option>
                    <option value="Komedian">Persona: Komedian</option>
                </select>
                <button id="add-to-queue-btn" class="btn btn-blue">
                    <i data-lucide="plus-circle"></i>
                    <span>Tambah</span>
                </button>
            </div>

            <div>
                <h2>Antrean Ebook</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Topik</th>
                                <th>Gaya</th>
                                <th>Persona</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="queue-table-body"></tbody>
                    </table>
                </div>
                <p id="empty-queue-msg" style="text-align: center; padding: 1rem; color: #64748b;">Antrean masih kosong.</p>
            </div>

            <div style="margin-top: 2rem;">
                <button id="process-queue-btn" class="btn btn-indigo btn-full" disabled>
                    <i data-lucide="play-circle"></i>
                    <span>Mulai Proses Antrean</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="ebook-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
            <h1 id="modal-title">Hasil</h1>
            <span class="close-button">&times;</span>
        </div>
        <div id="modal-body-content" class="modal-body"></div>
        <div id="modal-footer-content" class="modal-footer"></div>
      </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // --- Elemen DOM Awal (diperlukan untuk penanganan error) ---
        const authStatus = document.getElementById('auth-status');
        const licenseInput = document.getElementById('license-code-input');
        const verifyBtn = document.getElementById('verify-btn');

        try {
            // --- Impor Firebase ---
            // Pisahkan impor agar lebih mudah dibaca
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getFirestore, doc, getDoc, updateDoc, serverTimestamp, setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
        
            // --- KONFIGURASI DAN INISIALISASI ---
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const firebaseConfig = JSON.parse(firebaseConfigString);

            // [FIX] Periksa apakah konfigurasi Firebase valid sebelum melanjutkan.
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                throw new Error("Konfigurasi Firebase tidak ditemukan atau tidak valid. Aplikasi tidak dapat dijalankan.");
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'ebook-generator-app';

            // Inisialisasi Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            setLogLevel('debug'); // Aktifkan log untuk debugging

            // --- State Aplikasi ---
            let ebookQueue = [];
            let isProcessing = false;
            let currentUserId = null;

            // --- Elemen DOM Lanjutan ---
            const licenseView = document.getElementById('license-view');
            const appView = document.getElementById('app-view');
            const licenseForm = document.getElementById('license-form');
            const licenseError = document.getElementById('license-error');
            const verifyBtnText = document.getElementById('verify-btn-text');
            const verifyBtnSpinner = document.getElementById('verify-btn-spinner');
            const logoutBtn = document.getElementById('logout-btn');
            const activeLicenseCode = document.getElementById('active-license-code');
            const userIdDisplay = document.getElementById('user-id-display');
            const topicInput = document.getElementById('topic');
            const styleSelect = document.getElementById('style');
            const personaSelect = document.getElementById('persona');
            const addToQueueBtn = document.getElementById('add-to-queue-btn');
            const queueTableBody = document.getElementById('queue-table-body');
            const emptyQueueMsg = document.getElementById('empty-queue-msg');
            const processQueueBtn = document.getElementById('process-queue-btn');
            const ebookModal = document.getElementById('ebook-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body-content');
            const modalFooter = document.getElementById('modal-footer-content');
            const modalCloseBtn = document.querySelector('.close-button');
            
            // --- LOGIKA OTENTIKASI & LISENSI FIREBASE ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    authStatus.textContent = 'Terhubung. Siap memverifikasi.';
                    authStatus.style.color = '#16a34a';
                    licenseInput.disabled = false;
                    verifyBtn.disabled = false;

                    const savedCode = localStorage.getItem('ebookAppLicenseCode');
                    if (savedCode) {
                        setVerifyingState(true, 'Memverifikasi lisensi tersimpan...');
                        const result = await validateAndClaimLicense(savedCode);
                        handleVerificationResult(result, savedCode);
                        setVerifyingState(false);
                    }
                } else {
                    currentUserId = null;
                    authStatus.textContent = 'Gagal terhubung. Coba refresh halaman.';
                    authStatus.style.color = '#ef4444';
                }
            });

            async function initializeAuth() {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    // [FIX] Pesan error lebih spesifik
                    authStatus.textContent = `Gagal Otentikasi: ${error.message}. Periksa koneksi atau aturan keamanan Firebase.`;
                    authStatus.style.color = '#ef4444';
                }
            }
            
            async function validateAndClaimLicense(code) {
                if (!currentUserId) {
                    return { valid: false, message: 'ID Pengguna tidak ditemukan. Gagal validasi.' };
                }
                const licenseRef = doc(db, "licenses", code);
                try {
                    const licenseSnap = await getDoc(licenseRef);
                    if (!licenseSnap.exists()) {
                        return { valid: false, message: 'Kode lisensi tidak ditemukan.' };
                    }
                    const licenseData = licenseSnap.data();
                    if (licenseData.claimedBy && licenseData.claimedBy !== currentUserId) {
                        return { valid: false, message: 'Lisensi ini telah diklaim oleh pengguna lain.' };
                    }
                    if (!licenseData.claimedBy) {
                        await updateDoc(licenseRef, {
                            claimedBy: currentUserId,
                            claimedAt: serverTimestamp()
                        });
                        return { valid: true, message: 'Lisensi berhasil diklaim!' };
                    }
                    return { valid: true, message: 'Verifikasi lisensi berhasil.' };
                } catch (error) {
                    console.error("Error validating license in Firestore:", error);
                    return { valid: false, message: `Terjadi kesalahan saat validasi: ${error.message}` };
                }
            }

            licenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = licenseInput.value.trim();
                if (!code) return;
                setVerifyingState(true, 'Memverifikasi...');
                const result = await validateAndClaimLicense(code);
                handleVerificationResult(result, code);
                setVerifyingState(false);
            });
            
            function handleVerificationResult(result, code) {
                if (result.valid) {
                    localStorage.setItem('ebookAppLicenseCode', code);
                    showApp(code);
                } else {
                    licenseError.textContent = result.message;
                    licenseError.style.display = 'block';
                    localStorage.removeItem('ebookAppLicenseCode');
                }
            }

            logoutBtn.addEventListener('click', async () => {
                localStorage.removeItem('ebookAppLicenseCode');
                await signOut(auth);
                showLicenseView();
                initializeAuth();
            });
            
            function setVerifyingState(isVerifying, text = 'Verifikasi & Masuk') {
                verifyBtnText.textContent = text;
                if (isVerifying) {
                    verifyBtn.disabled = true;
                    licenseInput.disabled = true;
                    verifyBtnSpinner.classList.remove('hidden');
                    licenseError.style.display = 'none';
                } else {
                    verifyBtn.disabled = false;
                    licenseInput.disabled = false;
                    verifyBtnSpinner.classList.add('hidden');
                    verifyBtnText.textContent = 'Verifikasi & Masuk';
                }
            }

            function showApp(licenseCode) {
                licenseView.classList.add('hidden');
                appView.classList.remove('hidden');
                activeLicenseCode.textContent = licenseCode;
                userIdDisplay.textContent = currentUserId;
            }

            function showLicenseView() {
                appView.classList.add('hidden');
                licenseView.classList.remove('hidden');
                licenseInput.value = '';
                licenseError.style.display = 'none';
            }
            
            // --- LOGIKA APLIKASI UTAMA ---
            function addTopicToQueue() {
                const topic = topicInput.value.trim();
                if (topic) {
                    ebookQueue.push({ id: Date.now(), topic, style: styleSelect.value, persona: personaSelect.value, status: 'Menunggu', htmlContent: null });
                    topicInput.value = '';
                    renderQueueTable();
                } else {
                    showCustomAlert('Topik tidak boleh kosong.');
                }
            }

            function renderQueueTable() {
                emptyQueueMsg.style.display = ebookQueue.length === 0 ? 'block' : 'none';
                processQueueBtn.disabled = isProcessing || ebookQueue.length === 0;
                queueTableBody.innerHTML = ebookQueue.map(item => `
                    <tr id="row-${item.id}">
                        <td>${item.topic}</td>
                        <td>${item.style}</td>
                        <td>${item.persona}</td>
                        <td class="status-cell">${item.status === 'Proses...' ? '<div class="spinner status-spinner"></div>' : ''} ${item.status}</td>
                        <td class="action-cell">
                            ${(item.status === 'Selesai' || item.status === 'Gagal (Contoh Dibuat)') ? `<button class="btn btn-green view-result-btn" data-id="${item.id}" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Lihat</button>` : ''}
                        </td>
                    </tr>`).join('');
                document.querySelectorAll('.view-result-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const item = ebookQueue.find(q => q.id === parseInt(e.currentTarget.dataset.id));
                        if (item) showEbookInModal(item.htmlContent, item.status.includes('Contoh'));
                    };
                });
                lucide.createIcons();
            }
            
            async function processQueue() {
                isProcessing = true;
                renderQueueTable();
                for (const item of ebookQueue) {
                    if (item.status === 'Menunggu') {
                        updateItemStatus(item.id, 'Proses...');
                        try {
                            item.htmlContent = await generateEbook(item.topic, item.style, item.persona);
                            updateItemStatus(item.id, 'Selesai');
                        } catch (error) {
                            console.error(`Gagal membuat ebook untuk "${item.topic}":`, error);
                            item.htmlContent = generateFallbackEbook(item.topic);
                            updateItemStatus(item.id, 'Gagal (Contoh Dibuat)');
                        }
                    }
                }
                isProcessing = false;
                renderQueueTable();
                showCustomAlert('Semua antrean telah selesai diproses!');
            }
            
            function showCustomAlert(message) {
                modalTitle.textContent = "Informasi";
                modalBody.innerHTML = `<p>${message}</p>`;
                modalFooter.innerHTML = '';
                ebookModal.style.display = 'flex';
            }

            function updateItemStatus(id, status) {
                const item = ebookQueue.find(q => q.id === id);
                if (item) item.status = status;
                renderQueueTable();
            }

            async function callApiViaProxy(payload) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
                }
                return response.json();
            }
            
            function parseOutline(text) {
                const lines = text.split('\n').filter(line => line.trim() !== '');
                let title = "Judul Ebook";
                const titleLine = lines.find(line => line.match(/\*\*?Judul\*\*?:\s*/i));
                if (titleLine) title = titleLine.replace(/\*\*?Judul\*\*?:\s*/i, '').trim();
                else {
                    const firstLine = lines.find(line => !line.match(/\*\*?Bab\s*\d*:/i));
                    if(firstLine) title = firstLine.trim();
                }
                const chapters = lines.filter(line => line.match(/\*\*?Bab\s*\d*:/i)).map(line => line.replace(/\*\*?Bab\s*\d*:\s*/i, '').trim());
                if (chapters.length === 0) throw new Error("Gagal membuat outline bab.");
                return { title, chapters };
            }

            function saveAsPdf() {
                const element = document.getElementById('modal-ebook-content');
                const title = element.querySelector('.ebook-title')?.textContent || 'ebook';
                const fileName = title.trim().replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.pdf';
                const opt = { margin: [0.5, 0.5, 0.5, 0.5], filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }, pagebreak: { mode: 'css', before: '.ebook-chapter' } };
                html2pdf().set(opt).from(element).save();
            }

            function saveAsDocx() {
                const element = document.getElementById('modal-ebook-content');
                const title = element.querySelector('.ebook-title')?.textContent || 'ebook';
                const fileName = title.trim().replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.docx';
                const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${element.innerHTML}</body></html>`;
                saveAs(htmlDocx.asBlob(content), fileName);
            }
            
            function formatContent(text) {
                return text.replace(/\n{2,}/g, '</p><p>').replace(/\*/g,'');
            }
            
            function generateFallbackEbook(topic) {
                const title = `Contoh Ebook: ${topic}`;
                const chapters = [ "Pendahuluan", "Konsep Kunci", "Studi Kasus", "Tantangan dan Solusi", "Kesimpulan" ];
                const placeholderContent = "Ini adalah konten contoh yang ditampilkan karena terjadi kegagalan saat menghubungi server AI. Seharusnya, di sini akan terisi teks yang relevan dengan judul bab di atas, menjelaskan konsep secara rinci. Namun, karena adanya kendala teknis, kami menampilkan teks pengganti ini untuk menunjukkan bagaimana struktur dan format ebook akan terlihat.";
                return renderEbookToHtml(title, chapters.map(chapterTitle => ({ title: chapterTitle, content: placeholderContent })));
            }

            async function generateEbook(topic, style, persona) {
                const promptOutline = `Buatkan outline TEKS SAJA untuk ebook dengan topik "${topic}". Beri judul yang menarik. Buat 5 bab. Format jawaban harus seperti ini, tanpa teks lain:\n**Judul:** [Judul Ebook Di Sini]\n**Bab 1:** [Judul Bab 1]\n**Bab 2:** [Judul Bab 2]\n**Bab 3:** [Judul Bab 3]\n**Bab 4:** [Judul Bab 4]\n**Bab 5:** [Judul Bab 5]`;
                const outlineResult = await callApiViaProxy({ contents: [{ role: "user", parts: [{ text: promptOutline }] }] });
                const { title, chapters } = parseOutline(outlineResult.candidates[0].content.parts[0].text);
                
                const ebookData = [];
                for (const chapterTitle of chapters) {
                    const contentPrompt = `Anda adalah seorang penulis dengan persona sebagai **${persona}**. Tulis konten yang bersih dan terformat dengan baik untuk sebuah bab buku berjudul "${chapterTitle}" dari ebook bertopik "${topic}". Gunakan gaya bahasa "${style}". Pastikan ada struktur paragraf yang jelas. Panjang tulisan sekitar 400-500 kata.`;
                    const contentResult = await callApiViaProxy({ contents: [{ role: "user", parts: [{ text: contentPrompt }] }] });
                    ebookData.push({ title: chapterTitle, content: contentResult.candidates[0].content.parts[0].text });
                }
                return renderEbookToHtml(title, ebookData);
            }
            
            function renderEbookToHtml(title, ebookData) {
                let html = `<h1 class="ebook-title">${title}</h1>`;
                html += `<div class="ebook-toc"><h3 class="ebook-chapter-title">Daftar Isi</h3><ul>`;
                ebookData.forEach((chapter, index) => { html += `<li>Bab ${index + 1}: ${chapter.title}</li>`; });
                html += `</ul></div>`;
                ebookData.forEach((chapter, index) => {
                    html += `<div class="ebook-chapter">
                                <h2 class="ebook-chapter-title">Bab ${index + 1}: ${chapter.title}</h2>
                                <div class="ebook-chapter-content"><p>${formatContent(chapter.content)}</p></div>
                             </div>`;
                });
                return html;
            }

            function showEbookInModal(htmlContent, isFallback) {
                modalTitle.textContent = isFallback ? "Contoh Ebook (Gagal Terhubung ke AI)" : "Hasil Ebook";
                modalBody.innerHTML = `<div id="modal-ebook-content" class="ebook-container">${htmlContent}</div>`;
                modalFooter.innerHTML = `
                    <button id="modal-save-docx-btn" class="btn btn-orange"><i data-lucide="file-text"></i><span>Download (.docx)</span></button>
                    <button id="modal-save-pdf-btn" class="btn btn-green"><i data-lucide="download"></i><span>Simpan PDF</span></button>`;
                lucide.createIcons();
                document.getElementById('modal-save-pdf-btn').onclick = saveAsPdf;
                document.getElementById('modal-save-docx-btn').onclick = saveAsDocx;
                ebookModal.style.display = 'flex';
            }
            
            // --- Inisialisasi dan Event Listeners Global ---
            initializeAuth();
            renderQueueTable();
            lucide.createIcons();
            addToQueueBtn.addEventListener('click', addTopicToQueue);
            processQueueBtn.addEventListener('click', processQueue);
            modalCloseBtn.addEventListener('click', () => ebookModal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target == ebookModal) ebookModal.style.display = 'none';
            });

        } catch (e) {
            // [FIX] Tangkap semua error inisialisasi dan tampilkan di UI
            console.error("Aplikasi gagal diinisialisasi:", e);
            if (authStatus) {
                authStatus.textContent = `ERROR KRITIKAL: ${e.message}`;
                authStatus.style.color = '#ef4444';
            }
            if(licenseInput) licenseInput.disabled = true;
            if(verifyBtn) verifyBtn.disabled = true;
        }
    </script>
</body>
</html>
