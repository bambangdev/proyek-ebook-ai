<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pembuat Ebook AI</title>
    <!-- Google Fonts & Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* CSS Lengkap */
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --green-color: #16a34a;
            --red-color: #ef4444;
            --orange-color: #f97316;
            --blue-color: #3b82f6;
            --background-color: #f1f5f9;
            --text-color: #334155;
            --subtle-text: #64748b;
            --border-color: #e5e7eb;
            --card-bg: #ffffff;
        }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 1rem; box-sizing: border-box; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .app-container, .auth-container, .admin-container { background-color: var(--card-bg); width: 100%; max-width: 64rem; margin-left: auto; margin-right: auto; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: opacity 0.5s, transform 0.5s; }
        .auth-container { max-width: 28rem; }
        .auth-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-btn { flex: 1; padding: 0.75rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--subtle-text); border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .auth-form, .admin-form { display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input, .admin-form input, .admin-controls select { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        .app-header { text-align: center; margin-bottom: 1.5rem; }
        .app-header h1 { font-size: 1.875rem; font-weight: 700; }
        .app-header p { color: var(--subtle-text); margin-top: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
        @media (min-width: 1024px) { .form-grid { grid-template-columns: 2fr 1fr 1fr 1fr; } }
        .form-grid input, .form-grid select, .form-grid button { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        
        .btn { border: none; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); transition: background-color 0.2s; padding: 0.6rem 1rem; height: 42px; }
        .btn-blue { background-color: var(--blue-color); }
        .btn-indigo { background-color: var(--primary-color); }
        .btn-indigo:hover { background-color: var(--primary-hover); }
        .btn-green { background-color: var(--green-color); }
        .btn-red { background-color: var(--red-color); }
        .btn-orange { background-color: var(--orange-color); }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .table-container { overflow-x: auto; margin-top: 1rem; max-height: 60vh; }
        table { width: 100%; min-width: 700px; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; white-space: nowrap; }
        td:first-child, td:nth-child(2) { white-space: normal; word-break: break-all; }
        thead { background-color: #f9fafb; position: sticky; top: 0; z-index: 10;}
        .processing-row { background-color: #eff6ff; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .pulse-btn { animation: pulse 1.5s 3; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--card-bg); padding: 20px; border-radius: 0.75rem; width: 90%; max-width: 500px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h1 { font-size: 1.5rem; }
        .modal-body { max-height: 70vh; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; margin-top: 1rem; gap: 0.75rem; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .hidden { display: none !important; }
        .user-info { font-size: 0.8rem; color: var(--subtle-text); margin-bottom: 1rem; text-align: left; word-break: break-all;}
        #auth-error-msg { color: var(--red-color); text-align: center; margin-top: 1rem; min-height: 1.25rem; }
        .admin-action-btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; margin-right: 0.5rem;}
        #help-link { font-size: 0.9rem; text-align: center; margin-top: 1.5rem; }
        #help-link a { color: var(--primary-color); text-decoration: none; }
        .admin-controls { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; }
        
        #toast-notification { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; opacity: 0; transition: visibility 0.5s, opacity 0.5s, bottom 0.5s; }
        #toast-notification.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast-notification.success { background-color: var(--green-color); }
        #toast-notification.error { background-color: var(--red-color); }
    </style>
</head>
<body>

    <!-- Container untuk Login/Daftar -->
    <div id="auth-view" class="fade-in">
        <div class="auth-container">
            <div class="auth-tabs">
                <button id="show-login-btn" class="tab-btn active">Masuk</button>
                <button id="show-register-btn" class="tab-btn">Daftar Baru</button>
            </div>
            <div id="login-form-container">
                <h2 class="app-header" style="margin-bottom: 1rem;">Masuk dengan Email</h2>
                <form id="login-form" class="auth-form">
                    <input type="email" id="login-email" placeholder="Masukkan Email Anda" required>
                    <button type="submit" id="login-btn" class="btn btn-indigo">
                        <span>Masuk</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </form>
                 <p id="help-link"><a href="https://wa.link/u8668y" target="_blank">Butuh Bantuan?</a></p>
            </div>
            <div id="register-form-container" class="hidden">
                <h2 class="app-header" style="margin-bottom: 1rem;">Daftar Akun Baru</h2>
                <form id="register-form" class="auth-form">
                    <input type="text" id="register-name" placeholder="Nama Lengkap" required>
                    <input type="tel" id="register-whatsapp" placeholder="Nomor WhatsApp" required>
                    <input type="email" id="register-email" placeholder="Email Anda" required>
                    <button type="submit" id="register-btn" class="btn btn-indigo">
                        <span>Daftar & Masuk</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </form>
            </div>
            <p id="auth-error-msg"></p>
            <p id="auth-status" class="app-header" style="color:var(--subtle-text); font-size: 0.9rem; margin-top: 1.5rem;"></p>
        </div>
    </div>

    <!-- Container Aplikasi Utama -->
    <div id="app-view" class="hidden">
        <div id="main-container" class="app-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                 <div class="user-info">
                    <p>Email: <strong id="active-user-email"></strong></p>
                    <p>Kode Lisensi: <span id="active-license-code"></span></p>
                </div>
                <div>
                    <button id="admin-area-btn" class="btn btn-orange hidden" style="margin-right: 1rem;">Area Admin</button>
                    <button id="logout-btn" class="btn btn-red">Keluar</button>
                </div>
            </div>
            <div class="app-header">
                <h1>Ebook Generator AI</h1>
            </div>
            <div class="form-grid">
                <input type="text" id="topic" placeholder="Masukkan topik ebook...">
                <select id="style">
                    <option value="Santai dan Menarik">Gaya: Santai</option>
                    <option value="Formal dan Edukatif">Gaya: Formal</option>
                    <option value="Inspiratif dan Motivasi">Gaya: Motivasi</option>
                </select>
                <select id="persona">
                    <option value="Pakar di Bidangnya">Persona: Pakar</option>
                    <option value="Jurnalis Investigatif">Persona: Jurnalis</option>
                    <option value="Pencerita yang Handal">Persona: Pencerita</option>
                    <option value="Komedian">Persona: Komedian</option>
                </select>
                <button id="add-to-queue-btn" class="btn btn-blue">
                    <i data-lucide="plus-circle"></i>
                    <span>Tambah</span>
                </button>
            </div>
            <h2>Antrean Ebook</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Topik</th><th>Gaya</th><th>Persona</th><th>Status</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="queue-table-body"></tbody>
                </table>
            </div>
            <p id="empty-queue-msg" style="text-align: center; padding: 1rem; color: #64748b;">Antrean masih kosong.</p>
            <div style="margin-top: 2rem;">
                <button id="process-queue-btn" class="btn btn-indigo btn-full" disabled>
                    <i data-lucide="play-circle"></i>
                    <span>Mulai Buat Ebook</span>
                </button>
            </div>
        </div>
        
        <!-- Area Admin -->
        <div id="admin-view" class="admin-container hidden">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h1 class="app-header" style="margin: 0;">Manajemen Lisensi</h1>
                <button id="back-to-app-btn" class="btn btn-blue">Kembali ke Aplikasi</button>
            </div>
            <div class="admin-form" style="margin-bottom: 2rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 0.5rem;">
                <h3>Buat Lisensi Baru</h3>
                <form id="create-license-form" style="display: flex; gap: 1rem;">
                    <input type="text" id="new-license-key" placeholder="Masukkan Kode Lisensi Baru" required style="flex-grow: 1;">
                    <button type="submit" class="btn btn-green">Buat</button>
                </form>
            </div>
            <div class="admin-controls">
                <input type="search" id="admin-search-input" placeholder="Cari kode atau email..." style="flex-grow: 1;">
                <select id="admin-filter-select">
                    <option value="all">Semua Lisensi</option>
                    <option value="claimed">Sudah Diklaim</option>
                    <option value="unclaimed">Belum Diklaim</option>
                </select>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Kode Lisensi</th><th>Diklaim oleh (Email)</th><th>Nama</th><th>WhatsApp</th><th>Tanggal Klaim</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="admin-license-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal Universal -->
    <div id="app-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
            <h1 id="modal-title">Modal</h1>
            <span class="close-button">&times;</span>
        </div>
        <div id="modal-body" class="modal-body"></div>
        <div id="modal-footer" class="modal-footer"></div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification">Pesan Toast!</div>
    
    <!-- Firebase SDK -->
    <script type="module">
        const authStatus = document.getElementById('auth-status');

        try {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getAuth, signInAnonymously } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, serverTimestamp, setLogLevel, setDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
        
            const manualFirebaseConfig = {
                apiKey: "AIzaSyAnxE0CVOQGMyF0AUPtjIi_Utl3Y2vMX-w",
                authDomain: "ebook-generator-11e92.firebaseapp.com",
                databaseURL: "https://ebook-generator-11e92-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "ebook-generator-11e92",
                storageBucket: "ebook-generator-11e92.appspot.com",
                messagingSenderId: "892611289187",
                appId: "1:892611289187:web:e094185ed5873f409f1856",
                measurementId: "G-799ZLZNTK4"
            };
            const googleAiApiKey = "AIzaSyDwkouU7RGO3xJcHARuz9fQnEHVBAn3xm0";
            
            const firebaseConfig = (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) ? JSON.parse(__firebase_config) : manualFirebaseConfig;
            
            if (!firebaseConfig || firebaseConfig.apiKey.startsWith("GANTI_DENGAN")) throw new Error("Konfigurasi Firebase belum diisi.");
            if (!googleAiApiKey || googleAiApiKey.startsWith("GANTI_DENGAN")) throw new Error("Kunci API Google AI belum diisi.");
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            setLogLevel('debug');

            let ebookQueue = [];
            let isProcessing = false;
            let unsubscribeAdminListener = null;
            let allLicensesCache = [];

            // DOM Elements
            const authView = document.getElementById('auth-view');
            const appView = document.getElementById('app-view');
            const adminView = document.getElementById('admin-view');
            const mainContainer = document.getElementById('main-container');
            const adminAreaBtn = document.getElementById('admin-area-btn');
            const backToAppBtn = document.getElementById('back-to-app-btn');
            
            const loginFormContainer = document.getElementById('login-form-container');
            const registerFormContainer = document.getElementById('register-form-container');
            const showLoginBtn = document.getElementById('show-login-btn');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const loginForm = document.getElementById('login-form');
            const loginEmailInput = document.getElementById('login-email');
            const loginBtn = document.getElementById('login-btn');
            const registerForm = document.getElementById('register-form');
            const registerNameInput = document.getElementById('register-name');
            const registerWhatsappInput = document.getElementById('register-whatsapp');
            const registerEmailInput = document.getElementById('register-email');
            const registerLicenseInput = document.getElementById('register-license');
            const registerBtn = document.getElementById('register-btn');
            const authErrorMsg = document.getElementById('auth-error-msg');
            const logoutBtn = document.getElementById('logout-btn');
            const activeUserEmail = document.getElementById('active-user-email');
            const activeLicenseCode = document.getElementById('active-license-code');
            
            const topicInput = document.getElementById('topic');
            const styleSelect = document.getElementById('style');
            const personaSelect = document.getElementById('persona');
            const addToQueueBtn = document.getElementById('add-to-queue-btn');
            const queueTableBody = document.getElementById('queue-table-body');
            const emptyQueueMsg = document.getElementById('empty-queue-msg');
            const processQueueBtn = document.getElementById('process-queue-btn');
            const appModal = document.getElementById('app-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            const modalCloseBtn = document.querySelector('.close-button');

            const createLicenseForm = document.getElementById('create-license-form');
            const newLicenseKeyInput = document.getElementById('new-license-key');
            const adminSearchInput = document.getElementById('admin-search-input');
            const adminFilterSelect = document.getElementById('admin-filter-select');
            const adminLicenseTableBody = document.getElementById('admin-license-table-body');
            const toastNotification = document.getElementById('toast-notification');
            
            // --- UI & AUTH LOGIC ---
            function toggleAuthView(view) { 
                authErrorMsg.textContent = '';
                const isLogin = view === 'login';
                loginFormContainer.classList.toggle('hidden', !isLogin);
                registerFormContainer.classList.toggle('hidden', isLogin);
                showLoginBtn.classList.toggle('active', isLogin);
                showRegisterBtn.classList.toggle('active', !isLogin);
            }
            showLoginBtn.addEventListener('click', () => toggleAuthView('login'));
            showRegisterBtn.addEventListener('click', () => toggleAuthView('register'));
            
            function setButtonLoading(button, isLoading) {
                const spinner = button.querySelector('.btn-spinner');
                const text = button.querySelector('span');
                button.disabled = isLoading;
                if (spinner) spinner.classList.toggle('hidden', !isLoading);
                if (text) text.style.opacity = isLoading ? '0.5' : '1';
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginEmailInput.value.trim().toLowerCase();
                if (!email) return;
                setButtonLoading(loginBtn, true);
                authErrorMsg.textContent = '';
                const q = query(collection(db, "licenses"), where("claimedByEmail", "==", email));
                try {
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        authErrorMsg.textContent = 'Email tidak terdaftar atau lisensi belum diaktifkan.';
                    } else {
                        const doc = querySnapshot.docs[0];
                        localStorage.setItem('ebookAppUserEmail', email);
                        showApp(email, doc.id);
                    }
                } catch (error) {
                    authErrorMsg.textContent = 'Terjadi kesalahan. Coba lagi.';
                } finally {
                    setButtonLoading(loginBtn, false);
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = registerNameInput.value.trim();
                const whatsapp = registerWhatsappInput.value.trim();
                const email = registerEmailInput.value.trim().toLowerCase();
                const licenseKey = registerLicenseInput.value.trim();
                if (!name || !whatsapp || !email || !licenseKey) {
                    authErrorMsg.textContent = 'Semua field wajib diisi.';
                    return;
                }
                
                setButtonLoading(registerBtn, true);
                authErrorMsg.textContent = '';

                try {
                    // Cek lisensi
                    const licenseRef = doc(db, "licenses", licenseKey);
                    const licenseSnap = await getDoc(licenseRef);
                    if (!licenseSnap.exists()) throw new Error('Kode lisensi tidak valid.');
                    if (licenseSnap.data().claimedByEmail) throw new Error('Kode lisensi sudah digunakan.');

                    // Cek email
                    const emailQuery = query(collection(db, "licenses"), where("claimedByEmail", "==", email));
                    const emailSnap = await getDocs(emailQuery);
                    if (!emailSnap.empty) throw new Error('Email ini sudah terdaftar. Silakan masuk.');

                    // Klaim lisensi
                    await updateDoc(licenseRef, {
                        claimedByEmail: email,
                        claimedByName: name,
                        claimedByWhatsapp: whatsapp,
                        claimedAt: serverTimestamp()
                    });

                    // Login
                    localStorage.setItem('ebookAppUserEmail', email);
                    showApp(email, licenseKey);

                } catch (error) {
                    authErrorMsg.textContent = error.message;
                } finally {
                    setButtonLoading(registerBtn, false);
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('ebookAppUserEmail');
                showAuthView();
            });

            function showApp(email, licenseCode) {
                authView.classList.add('hidden');
                appView.classList.remove('hidden');
                appView.classList.add('fade-in');
                activeUserEmail.textContent = email;
                activeLicenseCode.textContent = licenseCode;
                if (email === 'poopandastore@gmail.com') {
                    adminAreaBtn.classList.remove('hidden');
                } else {
                    adminAreaBtn.classList.add('hidden');
                }
            }

            function showAuthView() {
                window.location.reload();
            }

            async function init() {
                authStatus.textContent = 'Menunggu koneksi...';
                await signInAnonymously(auth);
                authStatus.textContent = '';
                const savedEmail = localStorage.getItem('ebookAppUserEmail');
                if (savedEmail) {
                    authStatus.textContent = `Mencoba masuk sebagai ${savedEmail}...`;
                    const q = query(collection(db, "licenses"), where("claimedByEmail", "==", savedEmail));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        showApp(savedEmail, querySnapshot.docs[0].id);
                    } else {
                        localStorage.removeItem('ebookAppUserEmail');
                        toggleAuthView('login');
                    }
                } else {
                    toggleAuthView('login');
                }
                authStatus.textContent = '';
            }
            
            // --- TOAST NOTIFICATION ---
            function showToast(message, type = 'success') {
                toastNotification.textContent = message;
                toastNotification.className = 'show ' + type;
                setTimeout(() => {
                    toastNotification.className = toastNotification.className.replace('show', '');
                }, 3000);
            }

            // --- ADMIN AREA LOGIC ---
            adminAreaBtn.addEventListener('click', () => {
                mainContainer.classList.add('hidden');
                adminView.classList.remove('hidden');
                adminView.classList.add('fade-in');
                loadAdminData();
            });

            backToAppBtn.addEventListener('click', () => {
                adminView.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                mainContainer.classList.add('fade-in');
                if (unsubscribeAdminListener) unsubscribeAdminListener();
            });

            function loadAdminData() {
                const q = query(collection(db, "licenses"));
                unsubscribeAdminListener = onSnapshot(q, (querySnapshot) => {
                    allLicensesCache = [];
                    querySnapshot.forEach((doc) => {
                        allLicensesCache.push({ id: doc.id, ...doc.data() });
                    });
                    filterAndRenderAdminTable();
                });
            }

            function filterAndRenderAdminTable() {
                const searchTerm = adminSearchInput.value.toLowerCase();
                const filterType = adminFilterSelect.value;
                
                const filteredLicenses = allLicensesCache.filter(lic => {
                    const matchesSearch = lic.id.toLowerCase().includes(searchTerm) || (lic.claimedByEmail && lic.claimedByEmail.toLowerCase().includes(searchTerm));
                    const matchesFilter = (filterType === 'all') || 
                                          (filterType === 'claimed' && lic.claimedByEmail) || 
                                          (filterType === 'unclaimed' && !lic.claimedByEmail);
                    return matchesSearch && matchesFilter;
                });

                renderAdminTable(filteredLicenses);
            }

            adminSearchInput.addEventListener('input', filterAndRenderAdminTable);
            adminFilterSelect.addEventListener('change', filterAndRenderAdminTable);


            function renderAdminTable(licenses) {
                adminLicenseTableBody.innerHTML = licenses.map(lic => `
                    <tr>
                        <td>${lic.id}</td>
                        <td>${lic.claimedByEmail || '<em>-</em>'}</td>
                        <td>${lic.claimedByName || '<em>-</em>'}</td>
                        <td>${lic.claimedByWhatsapp || '<em>-</em>'}</td>
                        <td>${lic.claimedAt ? new Date(lic.claimedAt.seconds * 1000).toLocaleString('id-ID') : '-'}</td>
                        <td>
                            <button class="btn btn-blue admin-action-btn edit-license-btn" data-id="${lic.id}" data-email="${lic.claimedByEmail || ''}">Edit</button>
                            <button class="btn btn-red admin-action-btn delete-license-btn" data-id="${lic.id}">Hapus</button>
                        </td>
                    </tr>
                `).join('');
                
                document.querySelectorAll('.edit-license-btn').forEach(btn => btn.addEventListener('click', handleEditLicense));
                document.querySelectorAll('.delete-license-btn').forEach(btn => btn.addEventListener('click', handleDeleteLicense));
            }

            createLicenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newKey = newLicenseKeyInput.value.trim();
                if (!newKey) return;
                try {
                    const licenseRef = doc(db, "licenses", newKey);
                    const licenseSnap = await getDoc(licenseRef);
                    if (licenseSnap.exists()) throw new Error('Lisensi dengan kunci ini sudah ada.');
                    await setDoc(licenseRef, {
                        claimedByEmail: null,
                        claimedByName: null,
                        claimedByWhatsapp: null,
                        claimedAt: null
                    });
                    showToast(`Lisensi "${newKey}" berhasil dibuat.`, 'success');
                    newLicenseKeyInput.value = '';
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'error');
                }
            });

            function handleEditLicense(e) {
                const id = e.target.dataset.id;
                const email = e.target.dataset.email;
                modalTitle.textContent = "Edit Lisensi";
                modalBody.innerHTML = `
                    <p>Mengedit lisensi: <strong>${id}</strong></p>
                    <form id="edit-license-modal-form" class="auth-form">
                        <label for="edit-license-email">Email Pengguna (kosongkan untuk membebaskan lisensi)</label>
                        <input type="email" id="edit-license-email" value="${email}" placeholder="Email pengguna baru...">
                    </form>
                `;
                modalFooter.innerHTML = `<button id="save-edit-license-btn" class="btn btn-green">Simpan</button>`;
                appModal.style.display = 'flex';

                document.getElementById('save-edit-license-btn').onclick = async () => {
                    const newEmail = document.getElementById('edit-license-email').value.trim().toLowerCase() || null;
                    const licenseRef = doc(db, "licenses", id);
                    try {
                        if (newEmail) {
                            const emailQuery = query(collection(db, "licenses"), where("claimedByEmail", "==", newEmail));
                            const emailSnap = await getDocs(emailQuery);
                            if (!emailSnap.empty && emailSnap.docs[0].id !== id) {
                                throw new Error('Email tersebut sudah digunakan oleh lisensi lain.');
                            }
                        }
                        
                        await updateDoc(licenseRef, {
                            claimedByEmail: newEmail,
                            claimedAt: newEmail ? serverTimestamp() : null
                        });
                        showToast('Lisensi berhasil diperbarui.', 'success');
                        appModal.style.display = 'none';
                    } catch (error) {
                       alert('Gagal memperbarui lisensi: ' + error.message);
                    }
                };
            }
            function handleDeleteLicense(e) {
                const id = e.target.dataset.id;
                modalTitle.textContent = "Konfirmasi Hapus";
                modalBody.innerHTML = `<p>Apakah Anda yakin ingin menghapus lisensi <strong>${id}</strong> secara permanen?</p>`;
                modalFooter.innerHTML = `<button id="confirm-delete-btn" class="btn btn-red">Ya, Hapus</button><button id="cancel-delete-btn" class="btn btn-blue">Batal</button>`;
                appModal.style.display = 'flex';

                document.getElementById('confirm-delete-btn').onclick = async () => {
                    try {
                        await deleteDoc(doc(db, "licenses", id));
                        showToast(`Lisensi ${id} berhasil dihapus.`, 'success');
                        appModal.style.display = 'none';
                    } catch (error) {
                        showToast(`Gagal menghapus lisensi: ${error.message}`, 'error');
                    }
                };
                 document.getElementById('cancel-delete-btn').onclick = () => appModal.style.display = 'none';
            }


            // --- EBOOK APP LOGIC ---
            async function callApiViaProxy(payload) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${googleAiApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    let errorData;
                    try {
                        errorData = JSON.parse(errorBody);
                    } catch(e) {
                         throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
                    }
                    const errorMessage = errorData.error?.message || `HTTP error! status: ${response.status}`;
                    throw new Error(errorMessage);
                }
                return response.json();
             }
            function addTopicToQueue() {
                const topic = topicInput.value.trim();
                if (topic) {
                    ebookQueue.push({ id: Date.now(), topic, style: styleSelect.value, persona: personaSelect.value, status: 'Menunggu', htmlContent: null });
                    topicInput.value = '';
                    renderQueueTable();
                } else {
                    showCustomAlert('Topik tidak boleh kosong.');
                }
             }
            function renderQueueTable() {
                emptyQueueMsg.style.display = ebookQueue.length === 0 ? 'block' : 'none';
                processQueueBtn.disabled = isProcessing || ebookQueue.length === 0;
                queueTableBody.innerHTML = ebookQueue.map(item => `
                    <tr id="row-${item.id}" class="${item.status.startsWith('Membuat') ? 'processing-row' : ''}">
                        <td>${item.topic}</td>
                        <td>${item.style}</td>
                        <td>${item.persona}</td>
                        <td class="status-cell">${item.status === 'Proses...' || item.status.startsWith('Membuat') ? '<div class="spinner status-spinner"></div>' : ''} ${item.status}</td>
                        <td class="action-cell">
                            ${(item.status === 'Selesai' || item.status.startsWith('Gagal')) ? `<button class="btn btn-green view-result-btn ${item.status === 'Selesai' ? 'pulse-btn' : ''}" data-id="${item.id}" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Lihat</button>` : ''}
                        </td>
                    </tr>`).join('');
                document.querySelectorAll('.view-result-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const item = ebookQueue.find(q => q.id === parseInt(e.currentTarget.dataset.id));
                        if (item) showEbookInModal(item.htmlContent, item.status.includes('Gagal'));
                    };
                });
                lucide.createIcons();
             }
            async function processQueue() { 
                isProcessing = true;
                renderQueueTable();
                for (const item of ebookQueue) {
                    if (item.status === 'Menunggu') {
                        try {
                            updateItemStatus(item.id, 'Membuat kerangka...');
                            const { title, chapters } = await generateOutline(item.topic);
                            
                            let ebookData = [];
                            for (let i = 0; i < chapters.length; i++) {
                                updateItemStatus(item.id, `Menulis Bab ${i + 1}...`);
                                const chapterContent = await generateChapterContent(item.topic, chapters[i], item.style, item.persona);
                                ebookData.push({ title: chapters[i], content: chapterContent });
                            }
                            item.htmlContent = renderEbookToHtml(title, ebookData);
                            updateItemStatus(item.id, 'Selesai');
                        } catch (error) {
                            console.error(`Gagal membuat ebook untuk "${item.topic}":`, error);
                            item.htmlContent = generateFallbackEbook(item.topic, error.message);
                            updateItemStatus(item.id, `Gagal (${error.message})`);
                        }
                    }
                }
                isProcessing = false;
                renderQueueTable();
                showCustomAlert('Semua antrean telah selesai diproses!');
            }
            function showCustomAlert(message) {
                 modalTitle.textContent = "Informasi";
                 modalBody.innerHTML = `<p>${message}</p>`;
                 modalFooter.innerHTML = '';
                 appModal.style.display = 'flex';
            }
            function updateItemStatus(id, status) {
                const item = ebookQueue.find(q => q.id === id);
                if (item) item.status = status;
                renderQueueTable();
             }
            function parseOutline(text) { 
                const lines = text.split('\n').filter(line => line.trim() !== '');
                let title = "Judul Ebook";
                const titleLine = lines.find(line => line.match(/\*\*?Judul\*\*?:\s*/i));
                if (titleLine) title = titleLine.replace(/\*\*?Judul\*\*?:\s*/i, '').trim();
                else {
                    const firstLine = lines.find(line => !line.match(/\*\*?Bab\s*\d*:/i));
                    if(firstLine) title = firstLine.trim();
                }
                const chapters = lines.filter(line => line.match(/\*\*?Bab\s*\d*:/i)).map(line => line.replace(/\*\*?Bab\s*\d*:\s*/i, '').trim());
                if (chapters.length === 0) throw new Error("Gagal membuat outline bab dari respons AI.");
                return { title, chapters };
             }
            function saveAsPdf() { 
                const element = document.getElementById('modal-ebook-content');
                const title = element.querySelector('.ebook-title')?.textContent || 'ebook';
                const fileName = title.trim().replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.pdf';
                const opt = { margin: [0.5, 0.5, 0.5, 0.5], filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }, pagebreak: { mode: 'css', before: '.ebook-chapter' } };
                html2pdf().set(opt).from(element).save();
            }
            function saveAsDocx() {
                const element = document.getElementById('modal-ebook-content');
                const title = element.querySelector('.ebook-title')?.textContent || 'ebook';
                const fileName = title.trim().replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.docx';
                const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${element.innerHTML}</body></html>`;
                saveAs(htmlDocx.asBlob(content), fileName);
             }
            function formatContent(text) {
                return text.replace(/\n{2,}/g, '</p><p>').replace(/\*/g,'');
             }
            function generateFallbackEbook(topic, errorMessage) {
                const title = `Gagal Membuat Ebook: ${topic}`;
                const chapters = [ "Detail Kesalahan" ];
                const placeholderContent = `Terjadi kesalahan saat menghubungi server AI. Pesan error: "${errorMessage}". Harap periksa kembali API Key Google AI Anda atau coba lagi nanti.`;
                return renderEbookToHtml(title, chapters.map(chapterTitle => ({ title: chapterTitle, content: placeholderContent })));
             }
            async function generateOutline(topic) {
                const promptOutline = `Buatkan outline TEKS SAJA untuk ebook dengan topik "${topic}". Beri judul yang menarik. Buat 5 bab. Format jawaban harus seperti ini, tanpa teks lain:\n**Judul:** [Judul Ebook Di Sini]\n**Bab 1:** [Judul Bab 1]\n**Bab 2:** [Judul Bab 2]\n**Bab 3:** [Judul Bab 3]\n**Bab 4:** [Judul Bab 4]\n**Bab 5:** [Judul Bab 5]`;
                const outlineResult = await callApiViaProxy({ contents: [{ role: "user", parts: [{ text: promptOutline }] }] });
                return parseOutline(outlineResult.candidates[0].content.parts[0].text);
            }
            
            async function generateChapterContent(topic, chapterTitle, style, persona) {
                const contentPrompt = `Anda adalah seorang penulis dengan persona sebagai **${persona}**. Tulis konten yang bersih dan terformat dengan baik untuk sebuah bab buku berjudul "${chapterTitle}" dari ebook bertopik "${topic}". Gunakan gaya bahasa "${style}". Pastikan ada struktur paragraf yang jelas. Panjang tulisan sekitar 400-500 kata.`;
                const contentResult = await callApiViaProxy({ contents: [{ role: "user", parts: [{ text: contentPrompt }] }] });
                return contentResult.candidates[0].content.parts[0].text;
            }

            function renderEbookToHtml(title, ebookData) { 
                let html = `<h1 class="ebook-title">${title}</h1>`;
                html += `<div class="ebook-toc"><h3 class="ebook-chapter-title">Daftar Isi</h3><ul>`;
                ebookData.forEach((chapter, index) => { html += `<li>Bab ${index + 1}: ${chapter.title}</li>`; });
                html += `</ul></div>`;
                ebookData.forEach((chapter, index) => {
                    html += `<div class="ebook-chapter">
                                <h2 class="ebook-chapter-title">Bab ${index + 1}: ${chapter.title}</h2>
                                <div class="ebook-chapter-content"><p>${formatContent(chapter.content)}</p></div>
                             </div>`;
                });
                return html;
            }
            function showEbookInModal(htmlContent, isFallback) { 
                modalTitle.textContent = isFallback ? "Hasil Ebook (Gagal)" : "Hasil Ebook";
                 modalBody.innerHTML = `<div id="modal-ebook-content" class="ebook-container">${htmlContent}</div>`;
                 modalFooter.innerHTML = `<button id="modal-save-docx-btn" class="btn btn-orange"><i data-lucide="file-text"></i><span>Download (.docx)</span></button><button id="modal-save-pdf-btn" class="btn btn-green"><i data-lucide="download"></i><span>Simpan PDF</span></button>`;
                 lucide.createIcons();
                 document.getElementById('modal-save-pdf-btn').onclick = saveAsPdf;
                 document.getElementById('modal-save-docx-btn').onclick = saveAsDocx;
                 appModal.style.display = 'flex';
            }
            
            // --- GLOBAL LISTENERS & INIT ---
            init();
            renderQueueTable();
            lucide.createIcons();
            addToQueueBtn.addEventListener('click', addTopicToQueue);
            processQueueBtn.addEventListener('click', processQueue);
            modalCloseBtn.addEventListener('click', () => appModal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target == appModal) appModal.style.display = 'none';
            });

        } catch (e) {
            console.error("Aplikasi gagal diinisialisasi:", e);
            if (authStatus) {
                authStatus.textContent = `ERROR KRITIKAL: ${e.message}`;
                authStatus.style.color = '#ef4444';
            }
        }
    </script>
</body>
</html>
