<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pembuat Ebook AI</title>
    <!-- Google Fonts & Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* CSS Lengkap */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; margin: 0; padding: 1rem; box-sizing: border-box; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .app-container, .auth-container, .admin-container { background-color: #fff; width: 100%; max-width: 64rem; margin-left: auto; margin-right: auto; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .auth-container { max-width: 28rem; }
        .auth-tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
        .tab-btn { flex: 1; padding: 0.75rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .auth-form, .admin-form { display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input, .admin-form input { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        .app-header { text-align: center; margin-bottom: 1.5rem; }
        .app-header h1 { font-size: 1.875rem; font-weight: 700; }
        .app-header p { color: #64748b; margin-top: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
        @media (min-width: 1024px) { .form-grid { grid-template-columns: 2fr 1fr 1fr 1fr; } }
        .form-grid input, .form-grid select, .form-grid button { border: 1px solid #cbd5e1; padding: 0.6rem 0.75rem; border-radius: 0.375rem; width: 100%; box-sizing: border-box; height: 42px; }
        .btn { border: none; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); transition: background-color 0.2s; padding: 0.6rem 1rem; height: 42px; }
        .btn-blue { background-color: #3b82f6; }
        .btn-blue:hover { background-color: #2563eb; }
        .btn-indigo { background-color: #4f46e5; }
        .btn-indigo:hover { background-color: #4338ca; }
        .btn-green { background-color: #16a34a; }
        .btn-green:hover { background-color: #15803d; }
        .btn-orange { background-color: #f97316; }
        .btn-orange:hover { background-color: #ea580c; }
        .btn-red { background-color: #ef4444; }
        .btn-red:hover { background-color: #dc2626; }
        .btn-full { width: 100%; }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .table-container { overflow-x: auto; margin-top: 1rem; max-height: 60vh; }
        table { width: 100%; min-width: 700px; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; text-align: left; white-space: nowrap; }
        td:first-child, td:nth-child(2) { white-space: normal; word-break: break-all; }
        thead { background-color: #f9fafb; position: sticky; top: 0; z-index: 10;}
        .ebook-container { background: white; padding: 2rem; max-width: 8.5in; margin: auto; }
        .ebook-title { font-family: 'Lora', serif; font-size: 2.8rem; font-weight: 700; text-align: center; margin-bottom: 2rem; }
        .ebook-toc h3, .ebook-chapter-title { font-family: 'Lora', serif; font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
        .ebook-toc ul { list-style-type: disc; padding-left: 1.5rem; }
        .ebook-toc li { margin-bottom: 0.5rem; }
        .ebook-chapter { margin-top: 2rem; page-break-before: always; }
        .ebook-chapter-content { font-family: 'Lora', serif; font-size: 1.1rem; line-height: 1.7; text-align: justify; }
        .ebook-chapter-content p { margin-bottom: 1rem; }
        .ebook-chapter-content p:last-child { margin-bottom: 0; }
        .spinner, .btn-spinner { border: 2px solid rgba(255, 255, 255, 0.3); width: 16px; height: 16px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; display: inline-block; }
        .status-cell .spinner { border-color: rgba(0,0,0,0.1); border-left-color: #09f; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 0.5rem; width: 90%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h1 { font-size: 1.5rem; }
        .modal-body { max-height: 70vh; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; margin-top: 1rem; gap: 0.75rem; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
        .hidden { display: none !important; }
        .user-info { font-size: 0.8rem; color: #64748b; margin-bottom: 1rem; text-align: left; word-break: break-all;}
        #auth-error-msg { color: #ef4444; text-align: center; margin-top: 1rem; min-height: 1.25rem; }
        .admin-action-btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; margin-right: 0.5rem;}
    </style>
</head>
<body>

    <!-- Container untuk Login/Daftar -->
    <div id="auth-view">
        <div class="auth-container">
            <div class="auth-tabs">
                <button id="show-login-btn" class="tab-btn active">Masuk</button>
                <button id="show-register-btn" class="tab-btn">Daftar Baru</button>
            </div>
            <div id="login-form-container">
                <h2 class="app-header" style="margin-bottom: 1rem;">Masuk dengan Email</h2>
                <form id="login-form" class="auth-form">
                    <input type="email" id="login-email" placeholder="Masukkan Email Anda" required>
                    <button type="submit" id="login-btn" class="btn btn-indigo">
                        <span>Masuk</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </form>
            </div>
            <div id="register-form-container" class="hidden">
                <h2 class="app-header" style="margin-bottom: 1rem;">Daftar dengan Lisensi</h2>
                <form id="register-form" class="auth-form">
                    <input type="email" id="register-email" placeholder="Masukkan Email Anda" required>
                    <input type="text" id="register-license" placeholder="Masukkan Kode Lisensi" required>
                    <button type="submit" id="register-btn" class="btn btn-indigo">
                        <span>Daftar & Masuk</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </form>
            </div>
            <p id="auth-error-msg"></p>
            <p id="auth-status" class="app-header" style="color:#64748b; font-size: 0.9rem; margin-top: 1.5rem;"></p>
        </div>
    </div>

    <!-- Container Aplikasi Utama -->
    <div id="app-view" class="hidden">
        <div id="main-container" class="app-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                 <div class="user-info">
                    <p>Email: <strong id="active-user-email"></strong></p>
                    <p>Kode Lisensi: <span id="active-license-code"></span></p>
                </div>
                <div>
                    <button id="admin-area-btn" class="btn btn-orange hidden" style="margin-right: 1rem;">Area Admin</button>
                    <button id="logout-btn" class="btn btn-red">Keluar</button>
                </div>
            </div>
            <div class="app-header">
                <h1>Ebook Generator AI</h1>
            </div>
            <div class="form-grid">
                <input type="text" id="topic" placeholder="Masukkan topik ebook...">
                <select id="style">
                    <option value="Santai dan Menarik">Gaya: Santai</option>
                    <option value="Formal dan Edukatif">Gaya: Formal</option>
                    <option value="Inspiratif dan Motivasi">Gaya: Motivasi</option>
                </select>
                <select id="persona">
                    <option value="Pakar di Bidangnya">Persona: Pakar</option>
                    <option value="Jurnalis Investigatif">Persona: Jurnalis</option>
                    <option value="Pencerita yang Handal">Persona: Pencerita</option>
                    <option value="Komedian">Persona: Komedian</option>
                </select>
                <button id="add-to-queue-btn" class="btn btn-blue">
                    <i data-lucide="plus-circle"></i>
                    <span>Tambah</span>
                </button>
            </div>
            <h2>Antrean Ebook</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Topik</th><th>Gaya</th><th>Persona</th><th>Status</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="queue-table-body"></tbody>
                </table>
            </div>
            <p id="empty-queue-msg" style="text-align: center; padding: 1rem; color: #64748b;">Antrean masih kosong.</p>
            <div style="margin-top: 2rem;">
                <button id="process-queue-btn" class="btn btn-indigo btn-full" disabled>
                    <i data-lucide="play-circle"></i>
                    <span>Mulai Proses Antrean</span>
                </button>
            </div>
        </div>
        
        <!-- Area Admin -->
        <div id="admin-view" class="admin-container hidden">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h1 class="app-header" style="margin: 0;">Manajemen Lisensi</h1>
                <button id="back-to-app-btn" class="btn btn-blue">Kembali ke Aplikasi</button>
            </div>
            <div class="admin-form" style="margin-bottom: 2rem; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                <h3>Buat Lisensi Baru</h3>
                <form id="create-license-form" style="display: flex; gap: 1rem;">
                    <input type="text" id="new-license-key" placeholder="Masukkan Kode Lisensi Baru" required style="flex-grow: 1;">
                    <button type="submit" class="btn btn-green">Buat</button>
                </form>
                <p id="admin-feedback" style="min-height: 1.25rem; margin: 0.5rem 0 0 0;"></p>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Kode Lisensi</th><th>Diklaim oleh (Email)</th><th>Tanggal Klaim</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="admin-license-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal Universal -->
    <div id="app-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
            <h1 id="modal-title">Modal</h1>
            <span class="close-button">&times;</span>
        </div>
        <div id="modal-body" class="modal-body"></div>
        <div id="modal-footer" class="modal-footer"></div>
      </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        const authStatus = document.getElementById('auth-status');

        try {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getAuth, signInAnonymously } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, serverTimestamp, setLogLevel, addDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
        
            const manualFirebaseConfig = {
                apiKey: "AIzaSyAnxE0CVOQGMyF0AUPtjIi_Utl3Y2vMX-w",
                authDomain: "ebook-generator-11e92.firebaseapp.com",
                databaseURL: "https://ebook-generator-11e92-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "ebook-generator-11e92",
                storageBucket: "ebook-generator-11e92.appspot.com",
                messagingSenderId: "892611289187",
                appId: "1:892611289187:web:e094185ed5873f409f1856",
                measurementId: "G-799ZLZNTK4"
            };
            const googleAiApiKey = "AIzaSyDwkouU7RGO3xJcHARuz9fQnEHVBAn3xm0";
            
            const firebaseConfig = (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) ? JSON.parse(__firebase_config) : manualFirebaseConfig;
            
            if (!firebaseConfig || firebaseConfig.apiKey.startsWith("GANTI_DENGAN")) throw new Error("Konfigurasi Firebase belum diisi.");
            if (!googleAiApiKey || googleAiApiKey.startsWith("GANTI_DENGAN")) throw new Error("Kunci API Google AI belum diisi.");
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            setLogLevel('debug');

            let ebookQueue = [];
            let isProcessing = false;
            let unsubscribeAdminListener = null;

            // DOM Elements
            const authView = document.getElementById('auth-view');
            const appView = document.getElementById('app-view');
            const adminView = document.getElementById('admin-view');
            const mainContainer = document.getElementById('main-container');
            const adminAreaBtn = document.getElementById('admin-area-btn');
            const backToAppBtn = document.getElementById('back-to-app-btn');
            
            const loginFormContainer = document.getElementById('login-form-container');
            const registerFormContainer = document.getElementById('register-form-container');
            const showLoginBtn = document.getElementById('show-login-btn');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const loginForm = document.getElementById('login-form');
            const loginEmailInput = document.getElementById('login-email');
            const loginBtn = document.getElementById('login-btn');
            const registerForm = document.getElementById('register-form');
            const registerEmailInput = document.getElementById('register-email');
            const registerLicenseInput = document.getElementById('register-license');
            const registerBtn = document.getElementById('register-btn');
            const authErrorMsg = document.getElementById('auth-error-msg');
            const logoutBtn = document.getElementById('logout-btn');
            const activeUserEmail = document.getElementById('active-user-email');
            const activeLicenseCode = document.getElementById('active-license-code');
            
            const topicInput = document.getElementById('topic');
            const styleSelect = document.getElementById('style');
            const personaSelect = document.getElementById('persona');
            const addToQueueBtn = document.getElementById('add-to-queue-btn');
            const queueTableBody = document.getElementById('queue-table-body');
            const emptyQueueMsg = document.getElementById('empty-queue-msg');
            const processQueueBtn = document.getElementById('process-queue-btn');
            const appModal = document.getElementById('app-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            const modalCloseBtn = document.querySelector('.close-button');

            const createLicenseForm = document.getElementById('create-license-form');
            const newLicenseKeyInput = document.getElementById('new-license-key');
            const adminFeedback = document.getElementById('admin-feedback');
            const adminLicenseTableBody = document.getElementById('admin-license-table-body');
            
            // --- UI & AUTH LOGIC ---
            function toggleAuthView(view) { /* ... same as before ... */ }
            showLoginBtn.addEventListener('click', () => toggleAuthView('login'));
            showRegisterBtn.addEventListener('click', () => toggleAuthView('register'));
            function setButtonLoading(button, isLoading) { /* ... same as before ... */ }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginEmailInput.value.trim().toLowerCase();
                if (!email) return;
                setButtonLoading(loginBtn, true);
                authErrorMsg.textContent = '';
                const q = query(collection(db, "licenses"), where("claimedByEmail", "==", email));
                try {
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        authErrorMsg.textContent = 'Email tidak terdaftar. Silakan daftar terlebih dahulu.';
                    } else {
                        const doc = querySnapshot.docs[0];
                        localStorage.setItem('ebookAppUserEmail', email);
                        showApp(email, doc.id);
                    }
                } catch (error) {
                    authErrorMsg.textContent = 'Terjadi kesalahan. Coba lagi.';
                } finally {
                    setButtonLoading(loginBtn, false);
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = registerEmailInput.value.trim().toLowerCase();
                const licenseKey = registerLicenseInput.value.trim();
                if (!email || !licenseKey) return;
                setButtonLoading(registerBtn, true);
                authErrorMsg.textContent = '';
                try {
                    const licenseRef = doc(db, "licenses", licenseKey);
                    const licenseSnap = await getDoc(licenseRef);
                    if (!licenseSnap.exists()) throw new Error('Kode lisensi tidak valid.');
                    if (licenseSnap.data().claimedByEmail) throw new Error('Kode lisensi sudah digunakan.');
                    const emailQuery = query(collection(db, "licenses"), where("claimedByEmail", "==", email));
                    const emailSnap = await getDocs(emailQuery);
                    if (!emailSnap.empty) throw new Error('Email ini sudah terdaftar dengan lisensi lain.');
                    await updateDoc(licenseRef, { claimedByEmail: email, claimedAt: serverTimestamp() });
                    localStorage.setItem('ebookAppUserEmail', email);
                    showApp(email, licenseKey);
                } catch (error) {
                    authErrorMsg.textContent = error.message;
                } finally {
                    setButtonLoading(registerBtn, false);
                }
            });

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('ebookAppUserEmail');
                showAuthView();
            });

            function showApp(email, licenseCode) {
                authView.classList.add('hidden');
                appView.classList.remove('hidden');
                activeUserEmail.textContent = email;
                activeLicenseCode.textContent = licenseCode;
                if (email === 'poopandastore@gmail.com') {
                    adminAreaBtn.classList.remove('hidden');
                }
            }

            function showAuthView() {
                appView.classList.add('hidden');
                adminView.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                authView.classList.remove('hidden');
                toggleAuthView('login');
                loginEmailInput.value = '';
                registerEmailInput.value = '';
                registerLicenseInput.value = '';
                adminAreaBtn.classList.add('hidden');
                if (unsubscribeAdminListener) unsubscribeAdminListener();
            }

            async function init() {
                authStatus.textContent = 'Menunggu koneksi...';
                await signInAnonymously(auth);
                authStatus.textContent = '';
                const savedEmail = localStorage.getItem('ebookAppUserEmail');
                if (savedEmail) {
                    authStatus.textContent = `Mencoba masuk sebagai ${savedEmail}...`;
                    const q = query(collection(db, "licenses"), where("claimedByEmail", "==", savedEmail));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        showApp(savedEmail, querySnapshot.docs[0].id);
                    } else {
                        localStorage.removeItem('ebookAppUserEmail');
                        showAuthView();
                    }
                } else {
                    showAuthView();
                }
                authStatus.textContent = '';
            }
            
            // --- ADMIN AREA LOGIC ---
            adminAreaBtn.addEventListener('click', () => {
                mainContainer.classList.add('hidden');
                adminView.classList.remove('hidden');
                loadAdminData();
            });

            backToAppBtn.addEventListener('click', () => {
                adminView.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                if (unsubscribeAdminListener) unsubscribeAdminListener();
            });

            function loadAdminData() {
                const q = query(collection(db, "licenses"));
                unsubscribeAdminListener = onSnapshot(q, (querySnapshot) => {
                    const licenses = [];
                    querySnapshot.forEach((doc) => {
                        licenses.push({ id: doc.id, ...doc.data() });
                    });
                    renderAdminTable(licenses);
                });
            }

            function renderAdminTable(licenses) {
                adminLicenseTableBody.innerHTML = licenses.map(lic => `
                    <tr>
                        <td>${lic.id}</td>
                        <td>${lic.claimedByEmail || '<em>Belum diklaim</em>'}</td>
                        <td>${lic.claimedAt ? new Date(lic.claimedAt.seconds * 1000).toLocaleString('id-ID') : '-'}</td>
                        <td>
                            <button class="btn btn-blue admin-action-btn edit-license-btn" data-id="${lic.id}" data-email="${lic.claimedByEmail || ''}">Edit</button>
                            <button class="btn btn-red admin-action-btn delete-license-btn" data-id="${lic.id}">Hapus</button>
                        </td>
                    </tr>
                `).join('');
                
                document.querySelectorAll('.edit-license-btn').forEach(btn => btn.addEventListener('click', handleEditLicense));
                document.querySelectorAll('.delete-license-btn').forEach(btn => btn.addEventListener('click', handleDeleteLicense));
            }

            createLicenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newKey = newLicenseKeyInput.value.trim();
                if (!newKey) return;
                adminFeedback.textContent = '';
                try {
                    const licenseRef = doc(db, "licenses", newKey);
                    const licenseSnap = await getDoc(licenseRef);
                    if (licenseSnap.exists()) throw new Error('Lisensi dengan kunci ini sudah ada.');
                    
                    await addDoc(collection(db, 'licenses'), { claimedByEmail: null, claimedAt: null }, newKey);
                    // Firestore v9 doesn't directly support setting doc with custom ID via addDoc. We can use setDoc
                     await (async () => {
                        const newDocRef = doc(db, "licenses", newKey);
                        await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(({ setDoc }) => setDoc(newDocRef, { claimedByEmail: null, claimedAt: null }));
                    })();


                    adminFeedback.style.color = 'green';
                    adminFeedback.textContent = `Lisensi "${newKey}" berhasil dibuat.`;
                    newLicenseKeyInput.value = '';
                } catch (error) {
                    adminFeedback.style.color = 'red';
                    adminFeedback.textContent = `Error: ${error.message}`;
                }
            });

            function handleEditLicense(e) {
                const id = e.target.dataset.id;
                const email = e.target.dataset.email;
                modalTitle.textContent = "Edit Lisensi";
                modalBody.innerHTML = `
                    <p>Mengedit lisensi: <strong>${id}</strong></p>
                    <form id="edit-license-modal-form" class="auth-form">
                        <label for="edit-license-email">Email Pengguna (kosongkan untuk membebaskan lisensi)</label>
                        <input type="email" id="edit-license-email" value="${email}" placeholder="Email pengguna baru...">
                    </form>
                `;
                modalFooter.innerHTML = `<button id="save-edit-license-btn" class="btn btn-green">Simpan</button>`;
                appModal.style.display = 'flex';

                document.getElementById('save-edit-license-btn').onclick = async () => {
                    const newEmail = document.getElementById('edit-license-email').value.trim() || null;
                    const licenseRef = doc(db, "licenses", id);
                    try {
                        await updateDoc(licenseRef, {
                            claimedByEmail: newEmail,
                            claimedAt: newEmail ? serverTimestamp() : null
                        });
                        appModal.style.display = 'none';
                    } catch (error) {
                       alert('Gagal memperbarui lisensi: ' + error.message);
                    }
                };
            }

            function handleDeleteLicense(e) {
                const id = e.target.dataset.id;
                modalTitle.textContent = "Konfirmasi Hapus";
                modalBody.innerHTML = `<p>Apakah Anda yakin ingin menghapus lisensi <strong>${id}</strong> secara permanen?</p>`;
                modalFooter.innerHTML = `<button id="confirm-delete-btn" class="btn btn-red">Ya, Hapus</button><button id="cancel-delete-btn" class="btn btn-blue">Batal</button>`;
                appModal.style.display = 'flex';

                document.getElementById('confirm-delete-btn').onclick = async () => {
                    try {
                        await deleteDoc(doc(db, "licenses", id));
                        appModal.style.display = 'none';
                    } catch (error) {
                        alert('Gagal menghapus lisensi: ' + error.message);
                    }
                };
                 document.getElementById('cancel-delete-btn').onclick = () => appModal.style.display = 'none';
            }


            // --- EBOOK APP LOGIC ---
            async function callApiViaProxy(payload) { /* ... same as before ... */ }
            function addTopicToQueue() { /* ... same as before ... */ }
            function renderQueueTable() { /* ... same as before ... */ }
            async function processQueue() { /* ... same as before ... */ }
            function showCustomAlert(message) {
                 modalTitle.textContent = "Informasi";
                 modalBody.innerHTML = `<p>${message}</p>`;
                 modalFooter.innerHTML = '';
                 appModal.style.display = 'flex';
            }
            function updateItemStatus(id, status) { /* ... same as before ... */ }
            function parseOutline(text) { /* ... same as before ... */ }
            function saveAsPdf() { /* ... same as before ... */ }
            function saveAsDocx() { /* ... same as before ... */ }
            function formatContent(text) { /* ... same as before ... */ }
            function generateFallbackEbook(topic, errorMessage) { /* ... same as before ... */ }
            async function generateEbook(topic, style, persona) { /* ... same as before ... */ }
            function renderEbookToHtml(title, ebookData) { /* ... same as before ... */ }
            function showEbookInModal(htmlContent, isFallback) {
                 modalTitle.textContent = isFallback ? "Hasil Ebook (Gagal)" : "Hasil Ebook";
                 modalBody.innerHTML = `<div id="modal-ebook-content" class="ebook-container">${htmlContent}</div>`;
                 modalFooter.innerHTML = `<button id="modal-save-docx-btn" class="btn btn-orange"><i data-lucide="file-text"></i><span>Download (.docx)</span></button><button id="modal-save-pdf-btn" class="btn btn-green"><i data-lucide="download"></i><span>Simpan PDF</span></button>`;
                 lucide.createIcons();
                 document.getElementById('modal-save-pdf-btn').onclick = saveAsPdf;
                 document.getElementById('modal-save-docx-btn').onclick = saveAsDocx;
                 appModal.style.display = 'flex';
            }
            
            // --- GLOBAL LISTENERS & INIT ---
            init();
            renderQueueTable();
            lucide.createIcons();
            addToQueueBtn.addEventListener('click', addTopicToQueue);
            processQueueBtn.addEventListener('click', processQueue);
            modalCloseBtn.addEventListener('click', () => appModal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target == appModal) appModal.style.display = 'none';
            });

        } catch (e) {
            console.error("Aplikasi gagal diinisialisasi:", e);
            if (authStatus) {
                authStatus.textContent = `ERROR KRITIKAL: ${e.message}`;
                authStatus.style.color = '#ef4444';
            }
        }
    </script>
</body>
</html>
